<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Or√ßamento Gr√°fico ‚Ä¢ DIGRA</title>
<style>
  :root{
    /* Tema azul fechado */
    --bg1:#0b1e3a; --bg2:#091a33; --bg3:#081426;
    --stroke:#e6e3f2; --muted:#6f7287; --card:#ffffff;
    --shadow:0 10px 30px rgba(8,20,38,.20);
    --r:14px; --rsm:10px;

    /* Cores UI */
    --primary-1:#0f6abf; --primary-2:#1590c7;   /* bot√µes padr√£o azul */
    --offset-1:#d97706; --offset-2:#f59e0b;     /* OFFSET ativo (laranja) */
    --digital-1:#0f9d58; --digital-2:#16a34a;   /* DIGITAL ativo (verde) */

    --kpi-bg: rgba(255,255,255,.92);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    color:#161b22;
    background:
      radial-gradient(60% 100% at 10% 0%, #133964 0%, transparent 60%),
      radial-gradient(60% 100% at 100% 0%, #0f3159 0%, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2) 50%, var(--bg3));
    background-attachment:fixed;
  }

  /* Layout menor e alinhado √† esquerda */
  .wrap{max-width:960px; margin:28px 0 130px 28px; padding:0 16px}

  /* Header */
  header.app{
    background:linear-gradient(135deg,#0b274d,#0f3b6e);
    border-radius:12px; padding:14px 18px;
    display:flex; gap:12px; align-items:center; box-shadow:var(--shadow)
  }
  .logo-img{
    width:34px; height:34px; border-radius:50%;
    display:block; object-fit:cover; background:#0e2f56;
    box-shadow: 0 6px 18px rgba(8,20,38,.18);
  }
  header.app h1{font-size:18px;margin:0;font-weight:700;color:#fff}

  /* Bot√µes */
  .btn{
    appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
    color:#fff;background:linear-gradient(135deg,var(--primary-1),var(--primary-2));
    box-shadow:0 6px 18px rgba(8,20,38,.12); transition:.15s
  }
  .btn.secondary{background:#0f2948;color:#dfe8ff;border:1px solid #28486f}
  .btn.ghost{background:transparent;color:#0f2948;border:1px solid #28486f}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Cards */
  .card{
    background:rgba(255,255,255,.95);border:1px solid var(--stroke);border-radius:var(--r);
    padding:16px;margin-top:14px;box-shadow:var(--shadow)
  }

  /* Tarja gradiente do card (igual ao print) */
  .card-header-bar{
    margin: -6px -6px 14px -6px;
    padding: 12px 14px; border-radius: 10px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45)),
      linear-gradient(135deg, #0f3b6e 0%, #11558f 45%, #1471b3 100%);
    border: 1px solid rgba(255,255,255,.55);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 2px 10px rgba(8,20,38,.10);
    display:flex; align-items:center; gap:10px;
  }
  .card-header-bar .dot{
    width:18px; height:18px; border-radius:50%; display:grid; place-items:center;
    color:#1471b3; background:#ffffff; box-shadow:0 1px 4px rgba(8,20,38,.15); font-size:12px;
  }
  .card-header-bar .title{ color:#ffffff; font-weight:700; letter-spacing:.2px; text-shadow:0 1px 1px rgba(0,0,0,.25); }

  /* Grids / Inputs */
  .grid{display:grid;gap:14px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:980px){.cols-3,.cols-4{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}

  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text],input[type=number],textarea,select{
    width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fbfcff;outline:none
  }
  textarea{min-height:64px;resize:vertical}

  /* OFFSET/DIGITAL grandes, com cores distintas quando ativos */
  .toggle{display:flex;gap:12px}
  .toggle .btn{min-width:180px; justify-content:center; display:flex; align-items:center; gap:8px; background:linear-gradient(135deg,#104a8a,#1471b3);}
  .toggle .btn.active[data-tec="OFFSET"]{ background:linear-gradient(135deg,var(--offset-1),var(--offset-2)); color:#fff; }
  .toggle .btn.active[data-tec="DIGITAL"]{ background:linear-gradient(135deg,var(--digital-1),var(--digital-2)); color:#fff; }
  .tec-msg{margin-top:8px; font-size:12px; color:#0b305a}

  /* Dropzone (imagens dentro, centralizadas) */
  .dropzone{
    border:2px dashed #9db7d4;border-radius:12px;padding:18px;background:#f3f8ff;text-align:center;color:#315477; cursor:pointer
  }
  .dz-hint{margin-bottom:8px}
  .dz-grid{
    display:grid; gap:10px; justify-items:center;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
  .thumb{width:120px;height:120px;border-radius:10px;overflow:hidden;position:relative;background:#e7eff8;box-shadow:0 2px 10px rgba(8,20,38,.12)}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}

  /* Tabelas */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#5b7694;text-align:left;padding:0 10px}
  tbody tr{background:#fff;box-shadow:0 2px 10px rgba(8,20,38,.1)}
  tbody td{padding:8px 10px}

  /* Resumo fixo + rodap√© dentro do resumo (sempre vis√≠vel) */
  .summary{position:fixed;left:0;right:0;bottom:0;padding:12px 0;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.2));backdrop-filter:blur(6px)}
  .summary .wrap{
    display:grid;grid-template-columns: 220px repeat(7, 1fr) 240px; gap:10px;margin:0 auto
  }
  .brand{display:flex;align-items:center;justify-content:center;background:var(--kpi-bg);border:1px solid var(--stroke);border-radius:12px;padding:10px;font-weight:700;color:#0f2948}
  .kpi{background:var(--kpi-bg);border-radius:12px;padding:10px;text-align:center;border:1px solid var(--stroke)}
  .kpi .k{font-size:12px;color:#3b5876}
  .kpi .v{font-size:16px;font-weight:800;margin-top:4px}
  .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}

  /* Bloco de impress√£o (o resumo e o rodap√© entram no PDF) */
  .print-summary{display:none}
  @media print{
    body{background:#fff}
    .summary{position:static; padding:0; background:#fff}
    .summary .wrap{grid-template-columns: 220px repeat(7, 1fr) 240px}
    .card{box-shadow:none}
    .print-summary{display:block; margin-top:10px}
    @page { size: A4; margin: 12mm }
  }
</style>
</head>
<body>
  <div class="wrap" id="printRoot">
    <!-- Header -->
    <header class="app">
      ./logo-digra.png
      <div id="logoFallback" style="display:none;width:34px;height:34px;border-radius:50%;place-items:center;background:#113b6f;color:#fff;font-weight:800">DG</div>
      <h1>Or√ßamento Gr√°fico</h1>
      <div style="flex:1"></div>
      <button id="btnEditBase" class="btn secondary">‚öôÔ∏è Valores Base</button>
      <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir / PDF</button>
    </header>

    <!-- Informa√ß√µes Iniciais -->
    <section class="card" id="cardInfo">
      <div class="card-header-bar"><div class="dot">üßæ</div><div class="title">Informa√ß√µes Iniciais</div></div>
      <div class="grid cols-3">
        <div>
          <label>Quantidade Total de Itens *</label>
          <input type="number" id="qtdItens" min="1" placeholder="ex: 1000" />
        </div>
        <div>
          <label>Tamanho Final do Produto *</label>
          <input type="text" id="tamFinal" placeholder="ex: 10x15cm" />
        </div>
        <div>
          <label>Tecnologia de Impress√£o *</label>
          <div class="toggle" role="group" aria-label="Tecnologia de Impress√£o">
            <button class="btn" id="btnOffset" data-tec="OFFSET" type="button">‚öôÔ∏è OFFSET</button>
            <button class="btn" id="btnDigital" data-tec="DIGITAL" type="button">üñ®Ô∏è DIGITAL</button>
          </div>
          <div id="tecMsg" class="tec-msg"></div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Descri√ß√£o do Servi√ßo</label>
          <textarea id="desc" placeholder="ex: Cartazes A3 couch√™ 150g, 4/0, lamina√ß√£o fosca..."></textarea>
        </div>
        <div>
          <label>Dados T√©cnicos</label>
          <textarea id="dadosTec" placeholder="ex: Sangria 3mm, tiragem 500, corte guilhotina..."></textarea>
        </div>
      </div>
    </section>

    <!-- Imagens do Projeto -->
    <section class="card" id="cardImgs">
      <div class="card-header-bar"><div class="dot">üñºÔ∏è</div><div class="title">Imagens do Projeto</div></div>
      <div class="dropzone" id="dropzone" tabindex="0">
        <div class="dz-hint">
          <div style="font-size:24px;opacity:.7">üñºÔ∏è</div>
          <div>Clique aqui para <b>ativar a colagem</b> e depois use <b>Ctrl+V</b> (ou arraste e solte)</div>
          <div class="small">As imagens aparecer√£o <b>dentro</b> desta √°rea</div>
        </div>
        <div class="dz-grid" id="dzGrid"></div>
      </div>
    </section>

    <!-- Pap√©is Utilizados -->
    <section class="card" id="cardPapeis">
      <div class="card-header-bar"><div class="dot">üìÑ</div><div class="title">Pap√©is Utilizados (OFFSET)</div></div>
      <button class="btn ghost" type="button" id="addPapel">+ Adicionar Papel</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Papel</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ por unidade</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblPapeis"></tbody>
      </table>
    </section>

    <!-- Materiais Utilizados -->
    <section class="card" id="cardMateriais">
      <div class="card-header-bar"><div class="dot">üõ†Ô∏è</div><div class="title">Materiais Utilizados</div></div>
      <button class="btn ghost" type="button" id="addMaterial">+ Adicionar Material</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:24%">Material</th>
            <th style="width:18%">Tipo</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMateriais"></tbody>
      </table>
    </section>

    <!-- Impress√£o Digital -->
    <section class="card" id="cardImp">
      <div class="card-header-bar"><div class="dot">üñ®Ô∏è</div><div class="title">Impress√£o Digital</div></div>
      <button class="btn ghost" type="button" id="addImp">+ Adicionar Impress√£o</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:26%">Tipo</th>
            <th style="width:14%">Formato</th>
            <th style="width:12%">Quantidade</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblImp"></tbody>
      </table>
    </section>

    <!-- M√£o de Obra (por minuto) -->
    <section class="card" id="cardMO">
      <div class="card-header-bar"><div class="dot">üë•</div><div class="title">M√£o de Obra (por minuto)</div></div>
      <button class="btn ghost" type="button" id="addMao">+ Adicionar Profissional</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Profissional</th>
            <th style="width:14%">Minutos</th>
            <th style="width:14%">R$ / minuto</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMao"></tbody>
      </table>
    </section>

    <!-- Bloco de impress√£o (opcional extra) -->
    <div class="print-summary">
      <hr/>
      <div><b>Resumo para impress√£o</b></div>
    </div>
  </div>

  <!-- Barra de resumo fixa (com rodap√© junto) -->
  <div class="summary">
    <div class="wrap">
      <div class="brand">‚ö° Alexandre | DIGRA Apps</div>
      <div class="kpi"><div class="k">Pap√©is</div><div class="v" id="kpiPapeis">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Materiais</div><div class="v" id="kpiMateriais">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Impress√£o</div><div class="v" id="kpiImp">R$ 0,00</div></div>
      <div class="kpi"><div class="k">M√£o de Obra</div><div class="v" id="kpiMao">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Acr√©sc. 10%</div><div class="v" id="kpiAcresc">R$ 0,00</div></div>
      <div class="kpi"><div class="k">TOTAL GERAL</div><div class="v" id="kpiTotal">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Valor Unit√°rio</div><div class="v" id="kpiUnit">R$ 0,00</div></div>
      <div class="right">
        <button class="btn secondary" id="btnEditBase2">‚öôÔ∏è Base</button>
        <button class="btn" id="btnPrint2">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Drawer de Valores Base -->
  <div id="drawer" style="position:fixed;inset:0;background:rgba(12,20,38,.45);display:none;align-items:stretch">
    <div style="margin-left:auto; width:min(900px,92%); background:#fff; height:100%;
                border-top-left-radius:18px; border-bottom-left-radius:18px; box-shadow:-8px 0 28px rgba(0,0,0,.25);
                display:flex; flex-direction:column;">
      <header style="padding:16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px">
        <strong>‚öôÔ∏è Valores Base e Configura√ß√µes</strong>
        <div style="flex:1"></div>
        <button class="btn ghost" id="btnCloseDrawer">Fechar</button>
      </header>
      <main style="padding:16px;overflow:auto">
        <div class="tabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <button class="tab" data-tab="papeis" style="padding:8px 12px;border-radius:999px;border:1px solid #e7e1ff;background:#f1f5ff;color:#0f3b6e;font-weight:700">Pap√©is</button>
          <button class="tab" data-tab="materiais" style="padding:8px 12px;border-radius:999px;border:1px solid #e7e1ff;background:#f1f5ff;color:#0f3b6e;font-weight:700">Materiais</button>
          <button class="tab" data-tab="imp" style="padding:8px 12px;border-radius:999px;border:1px solid #e7e1ff;background:#f1f5ff;color:#0f3b6e;font-weight:700">Impress√£o Digital</button>
          <button class="tab" data-tab="mao" style="padding:8px 12px;border-radius:999px;border:1px solid #e7e1ff;background:#f1f5ff;color:#0f3b6e;font-weight:700">M√£o de Obra</button>
          <span style="flex:1"></span>
          <button class="btn ghost" id="btnExport">Exportar JSON</button>
          <label class="btn ghost" for="importJson" style="cursor:pointer;">Importar JSON</label>
          <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </div>

        <!-- Papeis -->
        <section data-pane="papeis">
          <div class="small" style="margin-bottom:8px">Valores para OFFSET (Pacote 66√ó96, Folha, A3 e A4). As op√ß√µes de ‚Äúpapel digital 75g‚Äù foram removidas daqui.</div>
          <table>
            <thead><tr><th>Nome</th><th>R$ Pacote 66√ó96</th><th>R$ Folha</th><th>R$ A3</th><th>R$ A4</th><th>A√ß√µes</th></tr></thead>
            <tbody id="basePapeis"></tbody>
          </table>
          <button class="btn ghost" id="baseAddPapel" style="margin-top:10px">+ Adicionar Papel</button>
        </section>

        <!-- Materiais -->
        <section data-pane="materiais" style="display:none">
          <div class="small" style="margin-bottom:8px">Cada Material possui <b>Tipos</b> com <b>valor unit√°rio</b> pr√≥prio (ex.: Espiral ‚Üí 7 mm, 9 mm‚Ä¶).</div>
          <table>
            <thead><tr><th>Material</th><th>Tipo</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMateriais"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMaterial" style="margin-top:10px">+ Adicionar Linha</button>
        </section>

        <!-- Impress√£o Digital -->
        <section data-pane="imp" style="display:none">
          <div class="small" style="margin-bottom:8px">Somente A4/A3. Tipos humanizados (1/0 = PRETO 1 lado; 1/1 = PRETO F/V; 4/0 colorida; 4/4 colorido F/V).</div>
          <table>
            <thead><tr><th>Tipo</th><th>Formato</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseImp"></tbody>
          </table>
          <button class="btn ghost" id="baseAddImp" style="margin-top:10px">+ Adicionar Impress√£o</button>
        </section>

        <!-- M√£o de Obra -->
        <section data-pane="mao" style="display:none">
          <div class="small" style="margin-bottom:8px">Valores por <b>minuto</b> (j√° convertidos a partir da sua tabela). No lan√ßamento, informe apenas os <b>minutos</b>.</div>
          <table>
            <thead><tr><th>Profissional</th><th>R$ por minuto</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMao"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMao" style="margin-top:10px">+ Adicionar Profissional</button>
        </section>
      </main>
      <footer style="padding:12px 16px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn secondary" id="btnResetBase">‚Ü∫ Restaurar Padr√µes</button>
        <button class="btn" id="btnSaveBase">üíæ Salvar Altera√ß√µes</button>
      </footer>
    </div>
  </div>

<script>
(function(){
  const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const $  = (sel, el=document)=> el.querySelector(sel);
  const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));

  // ===== Estado e Base =====
  const STORAGE = { base:'digra.base.v2' };
  // Base OFICIAL (dos dados que voc√™ enviou)
  const DEFAULT_BASE = {
    papeis: [
      {nome:'ADESIVO FOSCO 180g', pacote:296.64, folha:2.97, a3:0.74, a4:0.33},
      {nome:'CART√ÉO TRIPLEX 250g', pacote:475.00, folha:3.17, a3:0.79, a4:0.35},
      {nome:'CARTOLINA BRANCA 180g', pacote:114.00, folha:1.14, a3:0.57, a4:0.29},
      {nome:'CARTOLINA BRANCA 240g', pacote:95.00, folha:0.95, a3:0.48, a4:0.24},
      {nome:'COUCH√ä 115g', pacote:192.00, folha:0.77, a3:0.19, a4:0.09},
      {nome:'COUCH√ä 150g', pacote:169.45, folha:0.68, a3:0.17, a4:0.08},
      {nome:'COUCH√ä 210g', pacote:256.69, folha:1.71, a3:0.43, a4:0.19},
      {nome:'KRAFT 110g', pacote:241.84, folha:0.97, a3:0.24, a4:0.11},
      {nome:'OPALINE 180g', pacote:114.00, folha:1.68, a3:0.42, a4:0.19},
      {nome:'OFFSET 75g', pacote:132.00, folha:0.53, a3:0.13, a4:0.06},
      {nome:'OFFSET 90g', pacote:236.71, folha:0.47, a3:0.12, a4:0.05},
      {nome:'OFFSET 120g', pacote:200.01, folha:0.80, a3:0.20, a4:0.09},
      {nome:'VERG√ä 80g', pacote:98.64, folha:0.39, a3:0.10, a4:0.04},
      {nome:'VERG√ä 180g', pacote:139.49, folha:1.12, a3:0.28, a4:0.12}
    ],
    // Materiais com TIPOS e valor unit√°rio POR TIPO
    materiais: [
      // Lazer Filme (por folha)
      {material:'Lazer Filme', tipo:'A3 (29,7√ó42,0)', valor:3.57},
      {material:'Lazer Filme', tipo:'Of√≠cio II (21,6√ó33,0)', valor:1.90},

      // Chapas
      {material:'Chapa Offset Positiva', tipo:'SAKURAI (400√ó520√ó0,30)', valor:7.58},
      {material:'Chapa Offset Positiva', tipo:'HEIDELBERG (459√ó525√ó0,15)', valor:14.00},
      {material:'Chapa Offset T√©rmica Digital (CTP)', tipo:'SAKURAI', valor:57.00},
      {material:'Chapa Offset T√©rmica Digital (CTP)', tipo:'HEIDELBERG', valor:54.50},

      // Espiral (unidade)
      {material:'Espiral', tipo:'7 mm', valor:0.11},
      {material:'Espiral', tipo:'9 mm', valor:0.13},
      {material:'Espiral', tipo:'12 mm', valor:0.28},
      {material:'Espiral', tipo:'14 mm', valor:0.36},
      {material:'Espiral', tipo:'17 mm', valor:0.44},
      {material:'Espiral', tipo:'20 mm', valor:0.64},
      {material:'Espiral', tipo:'23 mm', valor:0.75},
      {material:'Espiral', tipo:'25 mm', valor:0.98},
      {material:'Espiral', tipo:'29 mm', valor:1.25},
      {material:'Espiral', tipo:'33 mm', valor:1.52},
      {material:'Espiral', tipo:'40 mm', valor:1.70},
      {material:'Espiral', tipo:'45 mm', valor:2.37},
      {material:'Espiral', tipo:'50 mm', valor:3.16},

      // Capas PP (unidade)
      {material:'Capa para Encaderna√ß√£o PP', tipo:'Transparente', valor:0.40},
      {material:'Capa para Encaderna√ß√£o PP', tipo:'Preta', valor:0.30},

      // Fita dupla face (cm)
      {material:'Fita Dupla Face (cm)', tipo:'19 mm', valor:0.0050},
      {material:'Fita Dupla Face (cm)', tipo:'25 mm', valor:0.0043},
      {material:'Fita Dupla Face (cm)', tipo:'50 mm', valor:0.0086},

      // Bobina polietileno (cm)
      {material:'Bobina Polietileno (cm)', tipo:'34cm √ó 0,05mm √ó 60m', valor:0.0342},

      // Adesivo Vinil (metro)
      {material:'Adesivo Vinil (m)', tipo:'Preto', valor:14.40},
      {material:'Adesivo Vinil (m)', tipo:'Azul M√©dio', valor:15.86},
      {material:'Adesivo Vinil (m)', tipo:'Vermelho M√©dio', valor:18.31},
      {material:'Adesivo Vinil (m)', tipo:'Transparente', valor:9.90},
      {material:'Adesivo Vinil (m)', tipo:'M√°scara de Transfer√™ncia', valor:17.11},

      // Bolsa para pastas (unidade)
      {material:'Bolsa para Pastas', tipo:'25√ó11 (240g + Fita 19mm)', valor:0.27}
    ],
    imp: [
      {tipo:'PRETO (1 lado)', formato:'A4', valor:0.03},
      {tipo:'PRETO (1 lado)', formato:'A3', valor:0.06},
      {tipo:'PRETO (FRENTE E VERSO)', formato:'A4', valor:0.06},
      {tipo:'PRETO (FRENTE E VERSO)', formato:'A3', valor:0.12},
      {tipo:'Frente colorida', formato:'A4', valor:0.25},
      {tipo:'Frente colorida', formato:'A3', valor:0.46},
      {tipo:'Frente e verso colorido', formato:'A4', valor:0.50},
      {tipo:'Frente e verso colorido', formato:'A3', valor:0.92}
    ],
    // M√£o de obra por MINUTO (j√° convertidos)
    mao: [
      {prof:'Coordenador de Artes Gr√°ficas', valorMin:1.43},
      {prof:'Designer Gr√°fico', valorMin:1.08},
      {prof:'Or√ßamentista Gr√°fico', valorMin:0.69},
      {prof:'Mestre Impressor', valorMin:0.90},
      {prof:'Impressor Digital', valorMin:0.60},
      {prof:'Mestre Impressor Offset', valorMin:0.90},
      {prof:'Impressor Offset', valorMin:0.60},
      {prof:'Operador de Guilhotina', valorMin:0.60},
      {prof:'Mestre de Servi√ßos Gr√°ficos', valorMin:0.90},
      {prof:'Operador de Acabamento Gr√°fico', valorMin:0.60},
      {prof:'Encarregado', valorMin:0.90}
    ]
  };
  function loadBase(){ try{ return JSON.parse(localStorage.getItem(STORAGE.base)) || DEFAULT_BASE; }catch(e){ return DEFAULT_BASE; } }
  function saveBase(b){ localStorage.setItem(STORAGE.base, JSON.stringify(b)); }
  let BASE = loadBase();

  // ===== Tecnologia OFFSET/DIGITAL + aviso =====
  let tecnologia = 'DIGITAL';
  function setTec(t){
    tecnologia = t;
    $('#btnOffset').classList.toggle('active', t==='OFFSET');
    $('#btnDigital').classList.toggle('active', t==='DIGITAL');
    $('#btnOffset').setAttribute('data-tec','OFFSET');
    $('#btnDigital').setAttribute('data-tec','DIGITAL');
    $('#tecMsg').textContent = (t==='OFFSET')
      ? 'OFFSET selecionado: aplica acr√©scimo de 10% sobre Pap√©is + Materiais.'
      : 'DIGITAL selecionado: isento do acr√©scimo de 10%.';
    calc();
  }
  $('#btnOffset').addEventListener('click', ()=> setTec('OFFSET'));
  $('#btnDigital').addEventListener('click', ()=> setTec('DIGITAL'));
  setTec('DIGITAL');

  // ===== Papeis (OFFSET) =====
  const tbP = $('#tblPapeis');
  $('#addPapel').addEventListener('click', addRowPapel);
  function addRowPapel(){
    const tr=document.createElement('tr');

    const tdP=document.createElement('td');
    const selP=document.createElement('select');
    BASE.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; selP.appendChild(o); });
    tdP.appendChild(selP);

    const tdT=document.createElement('td');
    const selT=document.createElement('select');
    ['Pacote 66√ó96','Folha','A3','A4'].forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; selT.appendChild(o); });
    tdT.appendChild(selT);

    const tdQ=document.createElement('td'); const qtd=document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.placeholder='ex: 100'; tdQ.appendChild(qtd);
    const tdV=document.createElement('td'); const val=document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0'; val.placeholder='R$'; tdV.appendChild(val);
    const tdC=document.createElement('td'); tdC.textContent=fmt.format(0);
    const tdA=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; tdA.appendChild(del);

    tr.append(tdP,tdT,tdQ,tdV,tdC,tdA); tbP.appendChild(tr);

    function syncVal(){
      const def = BASE.papeis.find(x=>x.nome===selP.value);
      let v = 0;
      if(def){
        if(selT.value==='Pacote 66√ó96') v = def.pacote ?? 0;
        if(selT.value==='Folha') v = def.folha ?? 0;
        if(selT.value==='A3') v = def.a3 ?? 0;
        if(selT.value==='A4') v = def.a4 ?? 0;
      }
      val.value = v ? v.toFixed(2) : '';
      upd();
    }
    function upd(){
      const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
      tdC.textContent = fmt.format(c);
      calc();
    }
    selP.onchange=syncVal; selT.onchange=syncVal; qtd.oninput=upd; val.oninput=upd;
    syncVal();
    del.onclick=()=>{ tr.remove(); calc(); };
  }

  // ===== Materiais (Material -> Tipo com valor por tipo; Tamanho livre; Qtd; R$ unit) =====
  const tbM = $('#tblMateriais');
  $('#addMaterial').addEventListener('click', addRowMaterial);

  function materiaisList(){ // nomes √∫nicos
    return [...new Set(BASE.materiais.map(m=>m.material))];
  }
  function tiposFor(mat){
    return BASE.materiais.filter(m=>m.material===mat).map(m=>({nome:m.tipo, valor:m.valor}));
  }

  function addRowMaterial(){
    const tr=document.createElement('tr');

    // Material
    const tdMat=document.createElement('td');
    const selMat=document.createElement('select');
    materiaisList().forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; selMat.appendChild(o); });
    tdMat.appendChild(selMat);

    // Tipo
    const tdTipo=document.createElement('td');
    const selTipo=document.createElement('select');
    tdTipo.appendChild(selTipo);

    // Tamanho (livre)
    const tdTam=document.createElement('td'); const tam=document.createElement('input'); tam.type='text'; tam.placeholder='ex: 10√ó15, 2m, 30cm...'; tdTam.appendChild(tam);

    // Quantidade
    const tdQtd=document.createElement('td'); const qtd=document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.placeholder='ex: 1'; tdQtd.appendChild(qtd);

    // Valor unit√°rio
    const tdVal=document.createElement('td'); const val=document.createElement('input'); val.type='number'; val.step='0.0001'; val.min='0'; val.placeholder='R$'; tdVal.appendChild(val);

    // Custo
    const tdC=document.createElement('td'); tdC.textContent=fmt.format(0);

    // A√ß√µes
    const tdA=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; tdA.appendChild(del);

    tr.append(tdMat,tdTipo,tdTam,tdQtd,tdVal,tdC,tdA); tbM.appendChild(tr);

    function fillTipos(){
      selTipo.innerHTML='';
      const tipos = tiposFor(selMat.value);
      tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t.nome; o.textContent=t.nome; o.dataset.valor=t.valor; selTipo.appendChild(o); });
      syncValorByTipo();
    }
    function syncValorByTipo(){
      const opt = selTipo.selectedOptions[0];
      val.value = opt ? Number(opt.dataset.valor).toFixed(4) : '';
      upd();
    }
    function upd(){
      const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
      tdC.textContent = fmt.format(c);
      calc();
    }

    selMat.onchange=fillTipos;
    selTipo.onchange=syncValorByTipo;
    qtd.oninput=upd; val.oninput=upd;

    fillTipos();
    del.onclick=()=>{ tr.remove(); calc(); };
  }

  // ===== Impress√£o Digital =====
  const tbI = $('#tblImp');
  $('#addImp').addEventListener('click', addRowImp);
  function tiposImp(){ return [...new Set(BASE.imp.map(i=>i.tipo))]; }
  function formatosForTipo(tipo){ return BASE.imp.filter(i=>i.tipo===tipo).map(i=>i.formato); }
  function valorImp(tipo, formato){ const it=BASE.imp.find(i=>i.tipo===tipo && i.formato===formato); return it? it.valor:0; }

  function addRowImp(){
    const tr=document.createElement('tr');

    const tdTipo=document.createElement('td');
    const selTipo=document.createElement('select'); tiposImp().forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
    tdTipo.appendChild(selTipo);

    const tdFmt=document.createElement('td');
    const selFmt=document.createElement('select'); tdFmt.appendChild(selFmt);

    const tdQtd=document.createElement('td'); const qtd=document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.placeholder='ex: 100'; tdQtd.appendChild(qtd);
    const tdVal=document.createElement('td'); const val=document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0'; val.placeholder='R$'; tdVal.appendChild(val);
    const tdC=document.createElement('td'); tdC.textContent = fmt.format(0);
    const tdA=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; tdA.appendChild(del);

    tr.append(tdTipo,tdFmt,tdQtd,tdVal,tdC,tdA); tbI.appendChild(tr);

    function fillFmt(){
      selFmt.innerHTML='';
      [...new Set(formatosForTipo(selTipo.value))].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFmt.appendChild(o); });
      syncV();
    }
    function syncV(){
      const v = valorImp(selTipo.value, selFmt.value)||0;
      val.value = v? v.toFixed(2): '';
      upd();
    }
    function upd(){
      const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
      tdC.textContent = fmt.format(c);
      calc();
    }

    selTipo.onchange=fillFmt; selFmt.onchange=syncV;
    qtd.oninput=upd; val.oninput=upd;
    fillFmt();
    del.onclick=()=>{ tr.remove(); calc(); };
  }

  // ===== M√£o de Obra (MINUTOS) =====
  const tbO = $('#tblMao');
  $('#addMao').addEventListener('click', addRowMao);
  function profs(){ return BASE.mao.map(m=>m.prof); }
  function valorMin(prof){ const m=BASE.mao.find(x=>x.prof===prof); return m? m.valorMin:0; }

  function addRowMao(){
    const tr=document.createElement('tr');

    const tdProf=document.createElement('td'); const sel=document.createElement('select');
    profs().forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
    tdProf.appendChild(sel);

    const tdMin=document.createElement('td'); const mins=document.createElement('input'); mins.type='number'; mins.min='1'; mins.placeholder='min'; tdMin.appendChild(mins);
    const tdVal=document.createElement('td'); const val=document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0'; val.placeholder='R$/min'; tdVal.appendChild(val);
    const tdC=document.createElement('td'); tdC.textContent = fmt.format(0);
    const tdA=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; tdA.appendChild(del);

    tr.append(tdProf,tdMin,tdVal,tdC,tdA); tbO.appendChild(tr);

    function syncVal(){ val.value = (valorMin(sel.value)||0).toFixed(2); upd(); }
    function upd(){ const c=(parseFloat(val.value)||0)*(parseFloat(mins.value)||0); tdC.textContent=fmt.format(c); calc(); }

    sel.onchange=syncVal; mins.oninput=upd; val.oninput=upd;
    syncVal();
    del.onclick=()=>{ tr.remove(); calc(); };
  }

  // ===== Resumo / C√°lculos =====
  function calc(){
    const sumP = Array.from(tbP.querySelectorAll('tr')).reduce((acc,tr)=> acc + ((+tr.children[2].querySelector('input').value||0) * (+tr.children[3].querySelector('input').value||0)), 0);
    const sumM = Array.from(tbM.querySelectorAll('tr')).reduce((acc,tr)=> acc + ((+tr.children[3].querySelector('input').value||0) * (+tr.children[4].querySelector('input').value||0)), 0);
    const sumI = Array.from(tbI.querySelectorAll('tr')).reduce((acc,tr)=> acc + ((+tr.children[2].querySelector('input').value||0) * (+tr.children[3].querySelector('input').value||0)), 0);
    const sumO = Array.from(tbO.querySelectorAll('tr')).reduce((acc,tr)=> acc + ((+tr.children[1].querySelector('input').value||0) * (+tr.children[2].querySelector('input').value||0)), 0);
    const acresc = tecnologia==='OFFSET' ? 0.10*(sumP+sumM) : 0;
    const total = sumP + sumM + sumI + sumO + acresc;

    $('#kpiPapeis').textContent = fmt.format(sumP);
    $('#kpiMateriais').textContent = fmt.format(sumM);
    $('#kpiImp').textContent = fmt.format(sumI);
    $('#kpiMao').textContent = fmt.format(sumO);
    $('#kpiAcresc').textContent = fmt.format(acresc);
    $('#kpiTotal').textContent = fmt.format(total);

    const itens = Math.max(1, parseInt($('#qtdItens').value||'0',10)) || 0;
    $('#kpiUnit').textContent = fmt.format(itens>0 ? total/itens : 0);
  }
  $('#qtdItens').addEventListener('input', calc);

  // ===== Dropzone / Ctrl+V dentro da √°rea =====
  const dz = $('#dropzone'); const grid = $('#dzGrid');
  let pasteActive = false;

  function addImg(url){
    const div=document.createElement('div'); div.className='thumb';
    const img=new Image(); img.src=url; div.appendChild(img);
    const x=document.createElement('button'); x.textContent='‚úñ'; x.title='Remover'; x.onclick=()=>div.remove();
    div.appendChild(x); grid.appendChild(div);
  }
  dz.addEventListener('click', ()=>{ pasteActive = true; dz.focus(); dz.style.outline='2px solid #1471b3'; setTimeout(()=> dz.style.outline='none', 600); });
  dz.addEventListener('dragover', e=>{ e.preventDefault(); });
  dz.addEventListener('drop', e=>{ e.preventDefault(); const fs=e.dataTransfer.files; for(const f of fs){ if(f.type.startsWith('image/')) addImg(URL.createObjectURL(f)); }});

  document.addEventListener('paste', e=>{
    if(!pasteActive) return;
    const items = e.clipboardData?.items||[];
    const imgs = []; for(const it of items){ if(it.type && it.type.startsWith('image/')) imgs.push(it.getAsFile()); }
    if(imgs.length){ e.preventDefault(); imgs.forEach(f=> addImg(URL.createObjectURL(f))); }
  });

  // ===== Print (A4, at√© 2 p√°ginas, com resumo e rodap√©) =====
  function preparePrint(){
    // desfixa o resumo para imprimir no fluxo
    const sum = document.querySelector('.summary'); const wasFixed = sum.style.position !== 'static';
    sum.style.position='static';
    window.print();
    // volta ao estado fixo ap√≥s impress√£o
    setTimeout(()=>{ sum.style.position='fixed'; }, 100);
  }
  $('#btnPrint').onclick = preparePrint; $('#btnPrint2').onclick = preparePrint;

  // ===== Drawer (Base) =====
  const drawer = $('#drawer');
  function openDrawer(pane='papeis'){ renderBase(); drawer.style.display='flex'; selectPane(pane); }
  function closeDrawer(){ drawer.style.display='none'; }
  $('#btnEditBase').onclick = ()=> openDrawer('papeis');
  $('#btnEditBase2').onclick = ()=> openDrawer('papeis');
  $('#btnCloseDrawer').onclick = closeDrawer;

  function selectPane(name){
    $$('[data-pane]').forEach(sec=> sec.style.display = (sec.getAttribute('data-pane')===name)?'block':'none');
    $$('.tab').forEach(t=> t.style.background = t.dataset.tab===name ? 'linear-gradient(135deg,#0f3b6e,#1471b3)' : '#f1f5ff');
    $$('.tab').forEach(t=> t.style.color = t.dataset.tab===name ? '#fff' : '#0f3b6e');
  }
  $$('.tab').forEach(tab=> tab.addEventListener('click', ()=> selectPane(tab.dataset.tab)));

  function rowDel(tdOnClick){ const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn ghost'; b.textContent='Remover'; b.onclick=tdOnClick; td.appendChild(b); return td; }

  function renderBase(){
    // Papeis
    const tP = $('#basePapeis'); tP.innerHTML='';
    BASE.papeis.forEach((p,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${p.nome}"></td>
        <td><input type="number" step="0.01" value="${p.pacote??0}"></td>
        <td><input type="number" step="0.01" value="${p.folha??0}"></td>
        <td><input type="number" step="0.01" value="${p.a3??0}"></td>
        <td><input type="number" step="0.01" value="${p.a4??0}"></td>`;
      tr.appendChild(rowDel(()=>{ BASE.papeis.splice(i,1); renderBase(); }));
      tP.appendChild(tr);
    });

    // Materiais (linhas at√¥micas: material + tipo + valor)
    const tM = $('#baseMateriais'); tM.innerHTML='';
    BASE.materiais.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${m.material}"></td>
        <td><input value="${m.tipo}"></td>
        <td><input type="number" step="0.0001" value="${m.valor}"></td>`;
      tr.appendChild(rowDel(()=>{ BASE.materiais.splice(i,1); renderBase(); }));
      tM.appendChild(tr);
    });

    // Impress√£o
    const tI = $('#baseImp'); tI.innerHTML='';
    BASE.imp.forEach((it,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><select>
          <option ${it.tipo==='PRETO (1 lado)'?'selected':''}>PRETO (1 lado)</option>
          <option ${it.tipo==='PRETO (FRENTE E VERSO)'?'selected':''}>PRETO (FRENTE E VERSO)</option>
          <option ${it.tipo==='Frente colorida'?'selected':''}>Frente colorida</option>
          <option ${it.tipo==='Frente e verso colorido'?'selected':''}>Frente e verso colorido</option>
        </select></td>
        <td><select>
          <option ${it.formato==='A4'?'selected':''}>A4</option>
          <option ${it.formato==='A3'?'selected':''}>A3</option>
        </select></td>
        <td><input type="number" step="0.01" value="${it.valor}"></td>`;
      tr.appendChild(rowDel(()=>{ BASE.imp.splice(i,1); renderBase(); }));
      tI.appendChild(tr);
    });

    // M√£o de obra (por minuto)
    const tO = $('#baseMao'); tO.innerHTML='';
    BASE.mao.forEach((o,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${o.prof}"></td>
        <td><input type="number" step="0.01" value="${o.valorMin}"></td>`;
      tr.appendChild(rowDel(()=>{ BASE.mao.splice(i,1); renderBase(); }));
      tO.appendChild(tr);
    });
  }

  $('#baseAddPapel').onclick = ()=>{ BASE.papeis.push({nome:'Novo Papel', pacote:0, folha:0, a3:0, a4:0}); renderBase(); };
  $('#baseAddMaterial').onclick = ()=>{ BASE.materiais.push({material:'Novo Material', tipo:'Tipo', valor:0}); renderBase(); };
  $('#baseAddImp').onclick = ()=>{ BASE.imp.push({tipo:'PRETO (1 lado)', formato:'A4', valor:0}); renderBase(); };
  $('#baseAddMao').onclick = ()=>{ BASE.mao.push({prof:'Novo Profissional', valorMin:0}); renderBase(); };

  $('#btnSaveBase').onclick = ()=>{
    // Salvar de volta
    const r = (sel)=> $$('#'+sel+' tr');
    BASE.papeis = r('basePapeis').map(tr=>({
      nome: tr.children[0].querySelector('input').value.trim(),
      pacote: +tr.children[1].querySelector('input').value||0,
      folha: +tr.children[2].querySelector('input').value||0,
      a3: +tr.children[3].querySelector('input').value||0,
      a4: +tr.children[4].querySelector('input').value||0
    }));
    BASE.materiais = r('baseMateriais').map(tr=>({
      material: tr.children[0].querySelector('input').value.trim(),
      tipo: tr.children[1].querySelector('input').value.trim(),
      valor: +tr.children[2].querySelector('input').value||0
    }));
    BASE.imp = r('baseImp').map(tr=>({
Alexandre
