<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Or√ßamento Gr√°fico ‚Ä¢ DIGRA</title>

  <!-- Fontes online (opcional). Se quiser 100% offline, posso empacotar as WOFF2 por @font-face. -->
  https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Lato:wght@400;700&display=swap

  <style>
    :root{
      /* Fundo padr√£o DIGRA (gradiente azul/roxo) */
      --bg1:#1a1440; --bg2:#140f3b; --bg3:#0e0c38;
      --stroke:#e6e3f2; --muted:#767398; --card:#fff;
      --shadow:0 10px 30px rgba(20,16,40,.18);
      --r:14px; --rsm:10px;
      --p1:#6d4bff; --p2:#3e8bff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Montserrat','Lato',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#211b2f;
      background:
        radial-gradient(60% 100% at 10% 0%, #6930c3 0%, transparent 60%),
        radial-gradient(60% 100% at 100% 0%, #4361ee 0%, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2) 50%, var(--bg3));
      background-attachment:fixed;
    }

    .wrap{max-width:1080px;margin:28px auto 110px;padding:0 16px}

    /* Header */
    header.app{
      background:#fff;border-radius:12px;padding:14px 18px;
      display:flex;gap:12px;align-items:center;box-shadow:var(--shadow)
    }
    .logo-img{
      width:34px; height:34px; border-radius:50%;
      display:block; object-fit:cover;
      box-shadow: 0 6px 18px rgba(20,16,40,.18);
    }
    @media print { .logo-img{ box-shadow:none; } }
    header.app h1{font-size:18px;margin:0;font-weight:700}

    /* Bot√µes */
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;
      color:#fff;background:linear-gradient(135deg,var(--p1),var(--p2));
      box-shadow:0 6px 18px rgba(20,16,40,.12)
    }
    .btn.secondary{background:#f1efff;color:#3a2c8c}
    .btn.ghost{background:transparent;color:#3a2c8c;border:1px solid #ded8ff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Cards */
    .card{
      background:rgba(255,255,255,.95);border:1px solid var(--stroke);border-radius:var(--r);
      padding:16px;margin-top:14px;box-shadow:var(--shadow)
    }

    /* Barra de t√≠tulo do card (tarja igual ao print) */
    .card-header-bar{
      margin: -6px -6px 14px -6px;
      padding: 12px 14px;
      border-radius: 10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45)),
        linear-gradient(135deg, #2c3ea8 0%, #6226c7 45%, #7b3af2 100%);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 2px 10px rgba(20,16,40,.10);
      display:flex; align-items:center; gap:10px;
    }
    .card-header-bar .dot{
      width:18px; height:18px; border-radius:50%;
      display:grid; place-items:center;
      color:#7b3af2; background:#ffffff;
      box-shadow:0 1px 4px rgba(20,16,40,.15);
      font-size:12px;
    }
    .card-header-bar .title{
      color:#ffffff; font-weight:700; letter-spacing:.2px;
      text-shadow:0 1px 1px rgba(0,0,0,.25);
    }

    /* Grid */
    .grid{display:grid;gap:14px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:980px){.cols-3,.cols-4{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}

    /* Inputs */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{
      width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fbfaff;outline:none
    }
    textarea{min-height:64px;resize:vertical}

    /* Toggle OFFSET/DIGITAL (igual ao print) */
    .toggle{display:flex;gap:10px}
    .toggle .btn{
      background:#fff; color:#3a2c8c; border:1px solid #e6e3f2;
      box-shadow: 0 2px 8px rgba(20,16,40,.06);
    }
    .toggle .btn.active{
      background:#ffffff; border-color:#d6d1ff;
      box-shadow: inset 0 0 0 2px #edeaff, 0 2px 10px rgba(20,16,40,.08);
      position: relative;
    }
    .toggle .btn.active::after{
      content:''; position:absolute; inset:0; border-radius:12px;
      background: radial-gradient(60% 100% at 0% 0%, rgba(123,58,242,.15), transparent 60%),
                  radial-gradient(50% 80% at 100% 0%, rgba(62,139,255,.15), transparent 60%);
      pointer-events:none;
    }

    /* Imagens */
    .dropzone{
      border:2px dashed #d7ceff;border-radius:12px;padding:22px;background:#fbfaff;text-align:center;color:#7b6ea8
    }
    .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .thumb{width:110px;height:110px;border-radius:10px;overflow:hidden;position:relative;background:#f1edff;box-shadow:0 2px 10px rgba(20,16,40,.12)}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}

    /* Tabelas */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#7a7493;text-align:left;padding:0 10px}
    tbody tr{background:#fff;box-shadow:0 2px 10px rgba(20,16,40,.1)}
    tbody td{padding:8px 10px}

    /* Resumo fixo inferior */
    .summary{position:fixed;left:0;right:0;bottom:0;padding:12px 0;background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.2));backdrop-filter:blur(6px)}
    .summary .wrap{
      display:grid;grid-template-columns:repeat(7, 1fr) 260px; /* 7 KPIs + a√ß√µes */
      gap:10px;margin:0 auto
    }
    .kpi{background:rgba(255,255,255,.92);border-radius:12px;padding:10px;text-align:center;border:1px solid var(--stroke)}
    .kpi .k{font-size:12px;color:#6f6a86}
    .kpi .v{font-size:16px;font-weight:800;margin-top:4px}
    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}

    /* Impress√£o */
    @media print{
      body{background:#fff}
      .summary, .drawer{display:none !important}
      .wrap{margin:0}
      .card{box-shadow:none}
      @page { size: A4; margin: 12mm }
    }

    /* Drawer de Valores Base */
    .drawer{position:fixed; inset:0; background:rgba(12,8,30,.45); display:none; align-items:stretch}
    .drawer.open{display:flex}
    .drawer .panel{
      margin-left:auto; width:min(880px, 92%); background:#fff; height:100%;
      border-top-left-radius:18px; border-bottom-left-radius:18px; box-shadow:-8px 0 28px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
    }
    .panel header{padding:16px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:12px}
    .panel main{padding:16px; overflow:auto}
    .panel footer{padding:12px 16px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end}

    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid #e7e1ff; background:#f8f7ff; color:#5a46ff; cursor:pointer; font-weight:700}
    .tab.active{background: linear-gradient(135deg, #6d4bff, #3e8bff); color:#fff}
    .small{font-size:12px; color:#7a7194}
  </style>
</head>
<body>
  <div class="wrap" id="printRoot">
    <!-- Header -->
    <header class="app">
      logo-digra.png
      <h1>Or√ßamento Gr√°fico</h1>
      <div style="flex:1"></div>
      <button id="btnEditBase" class="btn secondary">‚öôÔ∏è Editar Valores Base</button>
      <span></span>
      <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir / Salvar PDF</button>
    </header>

    <!-- Informa√ß√µes Iniciais -->
    <section class="card" id="cardInfo">
      <div class="card-header-bar">
        <div class="dot">üßæ</div>
        <div class="title">Informa√ß√µes Iniciais</div>
      </div>
      <div class="grid cols-3">
        <div>
          <label>Quantidade Total de Itens *</label>
          <input type="number" id="qtdItens" min="1" value="1000" />
        </div>
        <div>
          <label>Tamanho Final do Produto *</label>
          <input type="text" id="tamFinal" placeholder="Ex.: 10x15cm" />
        </div>
        <div>
          <label>Tecnologia de Impress√£o *</label>
          <div class="toggle" role="group" aria-label="Tecnologia de Impress√£o">
            <button class="btn" id="btnOffset" type="button">‚öôÔ∏è OFFSET</button>
            <button class="btn secondary" id="btnDigital" type="button">üñ®Ô∏è DIGITAL</button>
          </div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Descri√ß√£o do Servi√ßo</label>
          <textarea id="desc"></textarea>
        </div>
        <div>
          <label>Dados T√©cnicos</label>
          <textarea id="dadosTec"></textarea>
        </div>
      </div>
    </section>

    <!-- Imagens do Projeto -->
    <section class="card" id="cardImgs">
      <div class="card-header-bar">
        <div class="dot">üñºÔ∏è</div>
        <div class="title">Imagens do Projeto</div>
      </div>
      <div class="dropzone" id="dropzone" tabindex="0">
        <div style="font-size:28px;margin-bottom:8px">üñºÔ∏è</div>
        <div>Clique aqui e cole suas imagens (Ctrl+V)</div>
        <div class="small">Voc√™ pode colar m√∫ltiplas imagens ‚Ä¢ tamb√©m aceita arrastar e soltar</div>
      </div>
      <div class="thumbs" id="thumbs"></div>
    </section>

    <!-- Pap√©is Utilizados -->
    <section class="card" id="cardPapeis">
      <div class="card-header-bar">
        <div class="dot">üìÑ</div>
        <div class="title">Pap√©is Utilizados</div>
      </div>
      <button class="btn ghost" type="button" id="addPapel">+ Adicionar Papel</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Papel</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ por unidade</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblPapeis"></tbody>
      </table>
    </section>

    <!-- Materiais Utilizados -->
    <section class="card" id="cardMateriais">
      <div class="card-header-bar">
        <div class="dot">üõ†Ô∏è</div>
        <div class="title">Materiais Utilizados</div>
      </div>
      <button class="btn ghost" type="button" id="addMaterial">+ Adicionar Material</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:24%">Material</th>
            <th style="width:18%">Tipo</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMateriais"></tbody>
      </table>
    </section>

    <!-- Impress√£o Digital -->
    <section class="card" id="cardImp">
      <div class="card-header-bar">
        <div class="dot">üñ®Ô∏è</div>
        <div class="title">Impress√£o Digital</div>
      </div>
      <button class="btn ghost" type="button" id="addImp">+ Adicionar Impress√£o</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:26%">Tipo</th>
            <th style="width:14%">Formato</th>
            <th style="width:12%">Quantidade</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblImp"></tbody>
      </table>
    </section>

    <!-- M√£o de Obra -->
    <section class="card" id="cardMO">
      <div class="card-header-bar">
        <div class="dot">üë•</div>
        <div class="title">M√£o de Obra</div>
      </div>
      <button class="btn ghost" type="button" id="addMao">+ Adicionar Profissional</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Profissional</th>
            <th style="width:14%">Horas</th>
            <th style="width:14%">R$ / hora</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMao"></tbody>
      </table>
    </section>
  </div>

  <!-- Barra de resumo fixa -->
  <div class="summary">
    <div class="wrap">
      <div class="kpi"><div class="k">Pap√©is</div><div class="v" id="kpiPapeis">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Materiais</div><div class="v" id="kpiMateriais">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Impress√£o</div><div class="v" id="kpiImp">R$ 0,00</div></div>
      <div class="kpi"><div class="k">M√£o de Obra</div><div class="v" id="kpiMao">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Acr√©sc. 10%</div><div class="v" id="kpiAcresc">R$ 0,00</div></div>
      <div class="kpi"><div class="k">TOTAL GERAL</div><div class="v" id="kpiTotal">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Valor Unit√°rio</div><div class="v" id="kpiUnit">R$ 0,00</div></div>
      <div class="right">
        <button class="btn secondary" id="btnEditBase2">‚öôÔ∏è Valores Base</button>
        <button class="btn" id="btnPrint2">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Drawer de Valores Base -->
  <div class="drawer" id="drawer">
    <div class="panel">
      <header>
        <strong>‚öôÔ∏è Valores Base e Configura√ß√µes</strong>
        <div style="flex:1"></div>
        <button class="btn ghost" id="btnCloseDrawer">Fechar</button>
      </header>
      <main>
        <div class="tabs">
          <button class="tab active" data-tab="papeis">Pap√©is</button>
          <button class="tab" data-tab="materiais">Materiais</button>
          <button class="tab" data-tab="imp">Impress√£o Digital</button>
          <button class="tab" data-tab="mao">M√£o de Obra</button>
          <span style="flex:1"></span>
          <button class="btn ghost" id="btnExport">Exportar JSON</button>
          <label class="btn ghost" for="importJson" style="cursor:pointer;">Importar JSON</label>
          <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </div>

        <!-- Pap√©is -->
        <section data-pane="papeis">
          <div class="small" style="margin-bottom:8px">Preencha os valores por A4, A3, Folha (66√ó96) e Pacote. ‚ÄúFolhas/Pacote‚Äù define convers√µes autom√°ticas.</div>
          <table>
            <thead><tr><th>Nome do Papel</th><th>R$ A4</th><th>R$ A3</th><th>R$ Folha</th><th>R$ Pacote</th><th>Folhas/Pacote</th><th>A√ß√µes</th></tr></thead>
            <tbody id="basePapeis"></tbody>
          </table>
          <button class="btn ghost" id="baseAddPapel" style="margin-top:10px">+ Adicionar Papel</button>
        </section>

        <!-- Materiais -->
        <section data-pane="materiais" style="display:none">
          <div class="small" style="margin-bottom:8px">Separe m√∫ltiplos tipos por v√≠rgula. Ex.: ‚ÄúFosca, Brilho‚Äù.</div>
          <table>
            <thead><tr><th>Material</th><th>Tipos (",")</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMateriais"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMaterial" style="margin-top:10px">+ Adicionar Material</button>
        </section>

        <!-- Impress√£o Digital (somente A4/A3) -->
        <section data-pane="imp" style="display:none">
          <div class="small" style="margin-bottom:8px">Tipos humanizados (Frente 1 cor, Frente e verso 1 cor, Frente colorida, Frente e verso colorido) ‚Äî formatos A4/A3.</div>
          <table>
            <thead><tr><th>Tipo</th><th>Formato</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseImp"></tbody>
          </table>
          <button class="btn ghost" id="baseAddImp" style="margin-top:10px">+ Adicionar Impress√£o</button>
        </section>

        <!-- M√£o de Obra -->
        <section data-pane="mao" style="display:none">
          <table>
            <thead><tr><th>Profissional</th><th>R$ por Hora</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMao"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMao" style="margin-top:10px">+ Adicionar Profissional</button>
        </section>
      </main>
      <footer>
        <button class="btn secondary" id="btnResetBase">‚Ü∫ Restaurar Padr√µes</button>
        <button class="btn" id="btnSaveBase">üíæ Salvar Altera√ß√µes</button>
      </footer>
    </div>
  </div>

  <script>
    (function(){
      const fmtBR = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
      const $ = (sel, el=document) => el.querySelector(sel);
      const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

      // ================== ESTADO E BASE ==================
      const STORAGE = { base:'digra.base.v1' };

      // Base padr√£o (placeholders coerentes). Depois voc√™ pode editar no painel e/ou importar JSON oficial.
      const DEFAULT_BASE = {
        papeis:[
          {nome:'Couch√™ 115g', a4:0.45, a3:0.90, folha:2.80, pacote:140.00, folhasPacote:500},
          {nome:'Couch√™ 150g', a4:0.58, a3:1.16, folha:3.60, pacote:180.00, folhasPacote:500},
          {nome:'Offset 75g',  a4:0.06, a3:0.12, folha:0.30, pacote:132.00,  folhasPacote:250},
          {nome:'Offset 90g',  a4:0.12, a3:0.24, folha:0.47, pacote:236.71, folhasPacote:500},
          {nome:'Couch√™ 210g', a4:0.43, a3:0.86, folha:1.71, pacote:256.69, folhasPacote:150}
        ],
        materiais:[
          {nome:'Lamina√ß√£o', tipos:'Fosca,Brilho,Soft Touch', valor:1.20},
          {nome:'Verniz UV', tipos:'Total,Localizado', valor:0.60},
          {nome:'Fita Dupla Face 19mm (valor por cm)', tipos:'', valor:0.0050},
          {nome:'Bobina Polietileno 34cm x 0,05mm (valor por cm)', tipos:'', valor:0.03417},
          {nome:'Capa PP 0,30 (unidade)', tipos:'Transparente,Preta', valor:0.396}
        ],
        // Impress√£o Digital: TIPOS humanizados + FORMATO apenas A4/A3
        imps:[
          {tipo:'Frente 1 cor',            formato:'A4', valor:0.06},
          {tipo:'Frente 1 cor',            formato:'A3', valor:0.12},
          {tipo:'Frente e verso 1 cor',    formato:'A4', valor:0.12},
          {tipo:'Frente e verso 1 cor',    formato:'A3', valor:0.24},
          {tipo:'Frente colorida',         formato:'A4', valor:0.25},
          {tipo:'Frente colorida',         formato:'A3', valor:0.46},
          {tipo:'Frente e verso colorido', formato:'A4', valor:0.50},
          {tipo:'Frente e verso colorido', formato:'A3', valor:0.92}
        ],
        mao:[
          {prof:'Coordenador de Artes Gr√°ficas', valorHora:85.67},
          {prof:'Designer Gr√°fico',              valorHora:65.00},
          {prof:'Or√ßamentista Gr√°fico',          valorHora:41.37},
          {prof:'Impressor Digital',             valorHora:36.00},
          {prof:'Impressor Offset',              valorHora:36.00},
          {prof:'Operador de Guilhotina',        valorHora:36.00},
          {prof:'Acabamento',                    valorHora:30.00}
        ]
      };

      function loadBase(){
        try{ return JSON.parse(localStorage.getItem(STORAGE.base)) || JSON.parse(JSON.stringify(DEFAULT_BASE)); }
        catch(e){ return JSON.parse(JSON.stringify(DEFAULT_BASE)); }
      }
      function saveBase(base){ localStorage.setItem(STORAGE.base, JSON.stringify(base)); }
      let base = loadBase();

      // Estado da tela
      const state = {
        tecnologia: 'DIGITAL',
        itens: 1000
      };

      // ================== TECNOLOGIA OFFSET/DIGITAL ==================
      const btnOffset = $('#btnOffset');
      const btnDigital = $('#btnDigital');
      function setTecnologia(tec){
        state.tecnologia = tec;
        if(tec==='OFFSET'){
          btnOffset.classList.add('active'); btnOffset.classList.remove('secondary');
          btnDigital.classList.remove('active'); btnDigital.classList.add('secondary');
        }else{
          btnDigital.classList.add('active'); btnDigital.classList.remove('secondary');
          btnOffset.classList.remove('active'); btnOffset.classList.add('secondary');
        }
        recalc();
      }
      btnOffset.addEventListener('click',()=> setTecnologia('OFFSET'));
      btnDigital.addEventListener('click',()=> setTecnologia('DIGITAL'));
      setTecnologia('DIGITAL');

      // ================== PAP√âIS ==================
      const tblPapeis = $('#tblPapeis');
      $('#addPapel').addEventListener('click', ()=> addRowPapel());

      function addRowPapel(){
        const tr = document.createElement('tr');

        const tdPapel = document.createElement('td');
        const selPapel = document.createElement('select');
        base.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; selPapel.appendChild(o); });
        tdPapel.appendChild(selPapel);

        const tdTam = document.createElement('td');
        const selTam = document.createElement('select');
        ['A4','A3','Folha','Pacote'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTam.appendChild(o); });
        tdTam.appendChild(selTam);

        const tdQtd = document.createElement('td'); const inpQtd = document.createElement('input'); inpQtd.type='number'; inpQtd.min='1'; inpQtd.value='100'; tdQtd.appendChild(inpQtd);
        const tdVal = document.createElement('td'); const inpVal = document.createElement('input'); inpVal.type='number'; inpVal.min='0'; inpVal.step='0.01'; tdVal.appendChild(inpVal);
        const tdCusto = document.createElement('td'); tdCusto.textContent = fmtBR.format(0);
        const tdAcs = document.createElement('td'); const btnDel = document.createElement('button'); btnDel.className='btn ghost'; btnDel.textContent='Remover'; tdAcs.appendChild(btnDel);

        tr.appendChild(tdPapel); tr.appendChild(tdTam); tr.appendChild(tdQtd); tr.appendChild(tdVal); tr.appendChild(tdCusto); tr.appendChild(tdAcs);
        tblPapeis.appendChild(tr);

        function syncUnit(){
          const def = base.papeis.find(p=>p.nome===selPapel.value);
          const key = selTam.value.toLowerCase(); // a4, a3, folha, pacote
          let unit = 0;
          if(def){
            if(typeof def[key] === 'number' && def[key] >= 0){ unit = def[key]; }
            else {
              // fallback por convers√£o
              if(key==='a4' && typeof def.folha==='number'){ unit = Number(def.folha)/4; }
              else if(key==='a3' && typeof def.folha==='number'){ unit = Number(def.folha)/2; }
              else if(key==='folha' && typeof def.pacote==='number' && def.folhasPacote){ unit = Number(def.pacote)/Number(def.folhasPacote); }
              else unit = 0;
            }
          }
          inpVal.value = unit.toFixed(2);
          updateRow();
        }

        function updateRow(){
          const c = (parseFloat(inpVal.value)||0) * (parseFloat(inpQtd.value)||0);
          tdCusto.textContent = fmtBR.format(c);
          recalc();
        }

        selPapel.addEventListener('change', syncUnit);
        selTam.addEventListener('change', syncUnit);
        inpQtd.addEventListener('input', updateRow);
        inpVal.addEventListener('input', updateRow);

        syncUnit(); // inicia com valores da base
        btnDel.addEventListener('click', ()=>{ tr.remove(); recalc(); });
      }

      // ================== MATERIAIS ==================
      const tblMateriaisBody = $('#tblMateriais');
      $('#addMaterial').addEventListener('click', ()=> addRowMaterial());

      function addRowMaterial(){
        const tr = document.createElement('tr');

        // Material
        const tdMat = document.createElement('td');
        const selMat = document.createElement('select');
        base.materiais.forEach(m=>{ const o=document.createElement('option'); o.value=m.nome; o.textContent=m.nome; selMat.appendChild(o); });
        tdMat.appendChild(selMat);

        // Tipo (din√¢mico)
        const tdTipo = document.createElement('td'); const selTipo = document.createElement('select'); tdTipo.appendChild(selTipo);

        // Tamanho (texto livre)
        const tdTam = document.createElement('td'); const inpTam = document.createElement('input'); inpTam.type='text'; tdTam.appendChild(inpTam);

        // Qtd
        const tdQtd = document.createElement('td'); const inpQtd = document.createElement('input'); inpQtd.type='number'; inpQtd.min='1'; inpQtd.value='1'; tdQtd.appendChild(inpQtd);

        // Valor unit
        const tdVal = document.createElement('td'); const inpVal = document.createElement('input'); inpVal.type='number'; inpVal.step='0.01'; inpVal.min='0'; tdVal.appendChild(inpVal);

        // Custo
        const tdCusto = document.createElement('td'); tdCusto.textContent = fmtBR.format(0);

        // A√ß√µes
        const tdAcs = document.createElement('td'); const btnDel = document.createElement('button'); btnDel.className='btn ghost'; btnDel.textContent='Remover'; tdAcs.appendChild(btnDel);

        [tdMat, tdTipo, tdTam, tdQtd, tdVal, tdCusto, tdAcs].forEach(td=> tr.appendChild(td));
        tblMateriaisBody.appendChild(tr);

        function fillTipos(){
          selTipo.innerHTML='';
          const def = base.materiais.find(m=>m.nome===selMat.value);
          const tipos = (def?.tipos||'').split(',').map(s=>s.trim()).filter(Boolean);
          if(tipos.length){
            tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
          }else{
            const o=document.createElement('option'); o.value=''; o.textContent='‚Äî'; selTipo.appendChild(o);
          }
          inpVal.value = (def?.valor||0).toFixed(3);
          updateRow();
        }

        function updateRow(){
          const c = (parseFloat(inpVal.value)||0) * (parseFloat(inpQtd.value)||0);
          tdCusto.textContent = fmtBR.format(c);
          recalc();
        }

        selMat.addEventListener('change', fillTipos);
        inpQtd.addEventListener('input', updateRow);
        inpVal.addEventListener('input', updateRow);
        btnDel.addEventListener('click', ()=>{ tr.remove(); recalc(); });

        fillTipos(); // inicia com base
      }

      // ================== IMPRESS√ÉO DIGITAL (A4/A3 + tipos humanizados) ==================
      const tblImpBody = $('#tblImp');
      $('#addImp').addEventListener('click', ()=> addRowImp());

      function addRowImp(){
        const tr = document.createElement('tr');

        const tipos = [...new Set(base.imps.map(i=>i.tipo))];         // 'Frente 1 cor', 'Frente e verso 1 cor', ...
        const tdTipo = document.createElement('td');
        const selTipo = document.createElement('select');
        tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
        tdTipo.appendChild(selTipo);

        const tdFormato = document.createElement('td');
        const selFormato = document.createElement('select');
        tdFormato.appendChild(selFormato);

        const tdQtd = document.createElement('td'); const inpQtd = document.createElement('input'); inpQtd.type='number'; inpQtd.min='1'; inpQtd.value='100'; tdQtd.appendChild(inpQtd);
        const tdVal = document.createElement('td'); const inpVal = document.createElement('input'); inpVal.type='number'; inpVal.step='0.01'; inpVal.min='0'; tdVal.appendChild(inpVal);
        const tdCusto = document.createElement('td'); tdCusto.textContent = fmtBR.format(0);
        const tdAcs = document.createElement('td'); const btnDel = document.createElement('button'); btnDel.className='btn ghost'; btnDel.textContent='Remover'; tdAcs.appendChild(btnDel);

        [tdTipo, tdFormato, tdQtd, tdVal, tdCusto, tdAcs].forEach(td=> tr.appendChild(td));
        tblImpBody.appendChild(tr);

        function fillFormatos(){
          selFormato.innerHTML='';
          const formatos = base.imps.filter(x=>x.tipo===selTipo.value).map(x=>x.formato).filter(f=>f==='A4'||f==='A3');
          [...new Set(formatos)].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFormato.appendChild(o); });
          syncValor();
        }
        function syncValor(){
          const it = base.imps.find(x=>x.tipo===selTipo.value && x.formato===selFormato.value);
          inpVal.value = (it? it.valor: 0).toFixed(2);
          updateRow();
        }
        function updateRow(){
          const c = (parseFloat(inpVal.value)||0) * (parseFloat(inpQtd.value)||0);
          tdCusto.textContent = fmtBR.format(c);
          recalc();
        }

        selTipo.addEventListener('change', fillFormatos);
        selFormato.addEventListener('change', syncValor);
        inpQtd.addEventListener('input', updateRow);
        inpVal.addEventListener('input', updateRow);
        btnDel.addEventListener('click', ()=>{ tr.remove(); recalc(); });

        fillFormatos(); // inicia formato e valor
      }

      // ================== M√ÉO DE OBRA ==================
      const tblMaoBody = $('#tblMao');
      $('#addMao').addEventListener('click', ()=> addRowMao());

      function addRowMao(){
        const tr = document.createElement('tr');

        const tdProf = document.createElement('td');
        const selProf = document.createElement('select');
        base.mao.forEach(m=>{ const o=document.createElement('option'); o.value=m.prof; o.textContent=m.prof; selProf.appendChild(o); });
        tdProf.appendChild(selProf);

        const tdHoras = document.createElement('td'); const inpHoras = document.createElement('input'); inpHoras.type='number'; inpHoras.min='0.25'; inpHoras.step='0.25'; inpHoras.value='1'; tdHoras.appendChild(inpHoras);
        const tdVal   = document.createElement('td'); const inpVal = document.createElement('input');  inpVal.type='number'; inpVal.step='0.01';  inpVal.min='0'; tdVal.appendChild(inpVal);
        const tdCusto = document.createElement('td'); tdCusto.textContent = fmtBR.format(0);
        const tdAcs = document.createElement('td'); const btnDel = document.createElement('button'); btnDel.className='btn ghost'; btnDel.textContent='Remover'; tdAcs.appendChild(btnDel);

        [tdProf, tdHoras, tdVal, tdCusto, tdAcs].forEach(td=> tr.appendChild(td));
        tblMaoBody.appendChild(tr);

        function syncValor(){
          const def = base.mao.find(m=>m.prof===selProf.value);
          inpVal.value = (def?.valorHora||0).toFixed(2);
          updateRow();
        }
        function updateRow(){
          const c = (parseFloat(inpVal.value)||0) * (parseFloat(inpHoras.value)||0);
          tdCusto.textContent = fmtBR.format(c);
          recalc();
        }

        selProf.addEventListener('change', syncValor);
        inpHoras.addEventListener('input', updateRow);
        inpVal.addEventListener('input', updateRow);
        btnDel.addEventListener('click', ()=>{ tr.remove(); recalc(); });

        syncValor(); // inicia com valor/hora
      }

      // ================== RESUMO / C√ÅLCULO ==================
      function recalc(){
        const papelTotal = Array.from($('#tblPapeis').querySelectorAll('tr')).reduce((acc,tr)=>{
          const qtd = parseFloat(tr.children[2].querySelector('input').value)||0;
          const val = parseFloat(tr.children[3].querySelector('input').value)||0;
          const c = qtd*val; tr.children[4].textContent = fmtBR.format(c); return acc + c;
        },0);
        const matTotal = Array.from($('#tblMateriais').querySelectorAll('tr')).reduce((acc,tr)=>{
          const qtd = parseFloat(tr.children[3].querySelector('input').value)||0;
          const val = parseFloat(tr.children[4].querySelector('input').value)||0;
          const c = qtd*val; tr.children[5].textContent = fmtBR.format(c); return acc + c;
        },0);
        const impTotal = Array.from($('#tblImp').querySelectorAll('tr')).reduce((acc,tr)=>{
          const qtd = parseFloat(tr.children[2].querySelector('input').value)||0;
          const val = parseFloat(tr.children[3].querySelector('input').value)||0;
          const c = qtd*val; tr.children[4].textContent = fmtBR.format(c); return acc + c;
        },0);
        const maoTotal = Array.from($('#tblMao').querySelectorAll('tr')).reduce((acc,tr)=>{
          const horas = parseFloat(tr.children[1].querySelector('input').value)||0;
          const val = parseFloat(tr.children[2].querySelector('input').value)||0;
          const c = horas*val; tr.children[3].textContent = fmtBR.format(c); return acc + c;
        },0);

        const acresc = (state.tecnologia==='OFFSET') ? 0.10 * (papelTotal + matTotal) : 0;
        const total = papelTotal + matTotal + impTotal + maoTotal + acresc;

        $('#kpiPapeis').textContent = fmtBR.format(papelTotal);
        $('#kpiMateriais').textContent = fmtBR.format(matTotal);
        $('#kpiImp').textContent = fmtBR.format(impTotal);
        $('#kpiMao').textContent = fmtBR.format(maoTotal);
        $('#kpiAcresc').textContent = fmtBR.format(acresc);
        $('#kpiTotal').textContent = fmtBR.format(total);

        const itens = Math.max(1, parseInt($('#qtdItens').value||'1',10));
        const unit = total / itens;
        $('#kpiUnit').textContent = fmtBR.format(unit);
      }

      $('#qtdItens').addEventListener('input', ()=> recalc());

      // ================== DROPZONE / CTRL+V IMAGENS ==================
      const dz = $('#dropzone');
      const thumbs = $('#thumbs');
      function addImg(url){
        const div = document.createElement('div'); div.className='thumb';
        const img = new Image(); img.src = url; div.appendChild(img);
        const x = document.createElement('button'); x.textContent='‚úñ'; x.title='Remover'; x.onclick=()=> div.remove();
        div.appendChild(x); thumbs.appendChild(div);
      }
      dz.addEventListener('paste', (e)=>{
        const items = e.clipboardData?.items||[];
        for(const it of items){
          if(it.type && it.type.startsWith('image/')){
            const f = it.getAsFile(); const url = URL.createObjectURL(f); addImg(url);
          }
        }
      });
      dz.addEventListener('dragover', e=>{ e.preventDefault(); });
      dz.addEventListener('drop', e=>{ e.preventDefault(); const fs=e.dataTransfer.files; for(const f of fs){ if(f.type.startsWith('image/')) addImg(URL.createObjectURL(f)); }});
      dz.addEventListener('click', ()=> dz.focus());

      // ================== PRINT (A4, 1‚Äì2 p√°ginas, autoescala) ==================
      function prepareAndPrint(){
        const root = document.getElementById('printRoot');
        // mede A4 no dispositivo
        const probe = document.createElement('div');
        probe.style.width='210mm'; probe.style.height='297mm'; probe.style.position='absolute'; probe.style.visibility='hidden';
        document.body.appendChild(probe);
        const a4h = probe.getBoundingClientRect().height; document.body.removeChild(probe);

        const max = a4h*2 - 24; // margem de seguran√ßa
        const h = root.getBoundingClientRect().height;
        const scale = h>max ? (max/h) : 1;

        const oldT = root.style.transform, oldO = root.style.transformOrigin;
        root.style.transformOrigin = 'top center';
        root.style.transform = 'scale('+scale+')';
        setTimeout(()=>{ window.print(); setTimeout(()=>{ root.style.transform=oldT; root.style.transformOrigin=oldO; }, 100); }, 80);
      }
      $('#btnPrint').addEventListener('click', prepareAndPrint);
      $('#btnPrint2').addEventListener('click', prepareAndPrint);

      // ================== DRAWER (VALORES BASE) ==================
      const drawer = $('#drawer');
      function openDrawer(){ renderBaseTables(); drawer.classList.add('open'); }
      function closeDrawer(){ drawer.classList.remove('open'); }

      $('#btnEditBase').addEventListener('click', openDrawer);
      $('#btnEditBase2').addEventListener('click', openDrawer);
      $('#btnCloseDrawer').addEventListener('click', closeDrawer);

      $$('.tab').forEach(tab=> tab.addEventListener('click', ()=>{
        $$('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active');
        const pane = tab.dataset.tab;
        $$('[data-pane]').forEach(p=> p.style.display = (p.getAttribute('data-pane')===pane)?'block':'none');
      }));

      function rowDelButton(onClick){
        const td = document.createElement('td'); const b=document.createElement('button'); b.className='btn ghost'; b.textContent='Remover'; b.addEventListener('click', onClick); td.appendChild(b); return td;
      }

      function renderBaseTables(){
        // Pap√©is
        const tbP = $('#basePapeis'); tbP.innerHTML='';
        base.papeis.forEach((p,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${p.nome}"></td>
            <td><input type="number" step="0.01" value="${p.a4}"></td>
            <td><input type="number" step="0.01" value="${p.a3}"></td>
            <td><input type="number" step="0.01" value="${p.folha}"></td>
            <td><input type="number" step="0.01" value="${p.pacote}"></td>
            <td><input type="number" step="1" value="${p.folhasPacote||500}"></td>`;
          tr.appendChild(rowDelButton(()=>{ base.papeis.splice(idx,1); renderBaseTables(); syncPapelSelects(); }));
          tbP.appendChild(tr);
        });

        // Materiais
        const tbM = $('#baseMateriais'); tbM.innerHTML='';
        base.materiais.forEach((m,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${m.nome}"></td>
            <td><input value="${m.tipos}"></td>
            <td><input type="number" step="0.001" value="${m.valor}"></td>`;
          tr.appendChild(rowDelButton(()=>{ base.materiais.splice(idx,1); renderBaseTables(); syncMaterialSelects(); }));
          tbM.appendChild(tr);
        });

        // Impress√£o Digital
        const tbI = $('#baseImp'); tbI.innerHTML='';
        base.imps.forEach((i,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${i.tipo}"></td>
            <td><select>
                  <option ${i.formato==='A4'?'selected':''}>A4</option>
                  <option ${i.formato==='A3'?'selected':''}>A3</option>
                </select></td>
            <td><input type="number" step="0.01" value="${i.valor}"></td>`;
          tr.appendChild(rowDelButton(()=>{ base.imps.splice(idx,1); renderBaseTables(); }));
          tbI.appendChild(tr);
        });

        // M√£o de obra
        const tbO = $('#baseMao'); tbO.innerHTML='';
        base.mao.forEach((o,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${o.prof}"></td>
            <td><input type="number" step="0.01" value="${o.valorHora}"></td>`;
          tr.appendChild(rowDelButton(()=>{ base.mao.splice(idx,1); renderBaseTables(); syncMaoSelects(); }));
          tbO.appendChild(tr);
        });
      }

      // Adi√ß√µes
      $('#baseAddPapel').addEventListener('click',()=>{ base.papeis.push({nome:'Novo Papel', a4:0, a3:0, folha:0, pacote:0, folhasPacote:500}); renderBaseTables(); syncPapelSelects(); });
      $('#baseAddMaterial').addEventListener('click',()=>{ base.materiais.push({nome:'Novo Material', tipos:'Padr√£o', valor:0}); renderBaseTables(); syncMaterialSelects(); });
      $('#baseAddImp').addEventListener('click',()=>{ base.imps.push({tipo:'Frente 1 cor', formato:'A4', valor:0}); renderBaseTables(); });
      $('#baseAddMao').addEventListener('click',()=>{ base.mao.push({prof:'Novo Profissional', valorHora:0}); renderBaseTables(); syncMaoSelects(); });

      // Salvar base a partir das tabelas
      $('#btnSaveBase').addEventListener('click',()=>{
        function readRows(sel, map){ return $$('#'+sel+' tr').map(tr=> map(tr)); }

        base.papeis = readRows('basePapeis', tr=>({
          nome: tr.children[0].querySelector('input').value.trim(),
          a4: Number(tr.children[1].querySelector('input').value||0),
          a3: Number(tr.children[2].querySelector('input').value||0),
          folha: Number(tr.children[3].querySelector('input').value||0),
          pacote: Number(tr.children[4].querySelector('input').value||0),
          folhasPacote: Number(tr.children[5].querySelector('input').value||0)||500
        }));

        base.materiais = readRows('baseMateriais', tr=>({
          nome: tr.children[0].querySelector('input').value.trim(),
          tipos: tr.children[1].querySelector('input').value.trim(),
          valor: Number(tr.children[2].querySelector('input').value||0)
        }));

        base.imps = readRows('baseImp', tr=>({
          tipo: tr.children[0].querySelector('input').value.trim(),
          formato: tr.children[1].querySelector('select').value,
          valor: Number(tr.children[2].querySelector('input').value||0)
        }));

        base.mao = readRows('baseMao', tr=>({
          prof: tr.children[0].querySelector('input').value.trim(),
          valorHora: Number(tr.children[1].querySelector('input').value||0)
        }));

        saveBase(base);
        syncAllSelects();
        recalc();
        alert('Valores base salvos.');
      });

      $('#btnResetBase').addEventListener('click',()=>{
        if(confirm('Restaurar os valores padr√£o?')){
          base = JSON.parse(JSON.stringify(DEFAULT_BASE));
          saveBase(base);
          renderBaseTables();
          syncAllSelects();
          recalc();
        }
      });

      // Exportar / Importar base
      $('#btnExport').addEventListener('click',()=>{
        const data = JSON.stringify(base, null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='digra-valores-base.json'; a.click(); URL.revokeObjectURL(url);
      });
      $('#importJson').addEventListener('change', (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const rdr = new FileReader(); rdr.onload = ()=>{
          try{ base = JSON.parse(rdr.result); saveBase(base); renderBaseTables(); syncAllSelects(); recalc(); alert('Importado com sucesso.'); }
          catch(err){ alert('Arquivo inv√°lido.'); }
        }; rdr.readAsText(file);
      });

      // Sincronizar selects quando base muda
      function syncPapelSelects(){
        $$('#tblPapeis tr').forEach(tr=>{
          const sel = tr.children[0].querySelector('select'); const current = sel.value;
          sel.innerHTML=''; base.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; sel.appendChild(o); });
          sel.value = base.papeis.some(p=>p.nome===current)?current: (base.papeis[0]?.nome||'');
          sel.dispatchEvent(new Event('change'));
        });
      }
      function syncMaterialSelects(){
        $$('#tblMateriais tr').forEach(tr=>{
          const selMat = tr.children[0].querySelector('select'); const cur = selMat.value;
          selMat.innerHTML=''; base.materiais.forEach(m=>{ const o=document.createElement('option'); o.value=m.nome; o.textContent=m.nome; selMat.appendChild(o); });
          selMat.value = base.materiais.some(m=>m.nome===cur)?cur:(base.materiais[0]?.nome||'');
          // repopula tipos
          const selTipo = tr.children[1].querySelector('select');
          selTipo.innerHTML='';
          const def = base.materiais.find(m=>m.nome===selMat.value);
          (def?.tipos||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
          // atualiza valor unit
          const inpVal = tr.children[4].querySelector('input'); inpVal.value = (def?.valor||0).toFixed(3);
          tr.children[5].textContent = fmtBR.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[3].querySelector('input').value)||0));
        });
      }
      function syncImpSelects(){
        $$('#tblImp tr').forEach(tr=>{
          const selTipo = tr.children[0].querySelector('select'); const cur = selTipo.value;
          selTipo.innerHTML='';
          const tipos = [...new Set(base.imps.map(i=>i.tipo))];
          tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
          selTipo.value = tipos.includes(cur)?cur:(tipos[0]||'');

          // formatos
          const selFormato = tr.children[1].querySelector('select');
          selFormato.innerHTML='';
          const formatos = base.imps.filter(x=>x.tipo===selTipo.value).map(x=>x.formato).filter(f=>f==='A4'||f==='A3');
          [...new Set(formatos)].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFormato.appendChild(o); });

          // valor
          const it = base.imps.find(x=>x.tipo===selTipo.value && x.formato===selFormato.value);
          const inpVal = tr.children[3].querySelector('input');
          inpVal.value = (it? it.valor:0).toFixed(2);
          tr.children[4].textContent = fmtBR.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[2].querySelector('input').value)||0));
        });
      }
      function syncMaoSelects(){
        $$('#tblMao tr').forEach(tr=>{
          const sel = tr.children[0].querySelector('select'); const cur = sel.value;
          sel.innerHTML=''; base.mao.forEach(m=>{ const o=document.createElement('option'); o.value=m.prof; o.textContent=m.prof; sel.appendChild(o); });
          sel.value = base.mao.some(m=>m.prof===cur)?cur:(base.mao[0]?.prof||'');
          const inpVal = tr.children[2].querySelector('input'); const def = base.mao.find(m=>m.prof===sel.value);
          inpVal.value = (def?.valorHora||0).toFixed(2);
          tr.children[3].textContent = fmtBR.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[1].querySelector('input').value)||0));
        });
      }
      function syncAllSelects(){ syncPapelSelects(); syncMaterialSelects(); syncImpSelects(); syncMaoSelects(); }

      // Inicial
      recalc();

      // Atalhos: abrir Drawer e Print tamb√©m pelo rodap√©
      // (j√° configurado nos listeners acima)
    })();
  </script>
</body>
</html>
