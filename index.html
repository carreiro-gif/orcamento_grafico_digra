<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Or√ßamento Gr√°fico ‚Ä¢ DIGRA</title>

  <style>
    :root{
      --bg1:#1a1440; --bg2:#140f3b; --bg3:#0e0c38;
      --stroke:#e6e3f2; --muted:#767398; --card:#fff;
      --shadow:0 10px 30px rgba(20,16,40,.18);
      --r:14px; --p1:#6d4bff; --p2:#3e8bff;
      --ink:#211b2f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(60% 100% at 10% 0%, #6930c3 0%, transparent 60%),
        radial-gradient(60% 100% at 100% 0%, #4361ee 0%, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2) 50%, var(--bg3));
      background-attachment:fixed;
    }
    .wrap{max-width:1080px;margin:28px auto 120px;padding:0 16px}

    /* Header */
    header.app{
      background:#fff;border-radius:12px;padding:14px 18px;
      display:flex;gap:12px;align-items:center;box-shadow:var(--shadow)
    }
    .logo-img{
      width:34px;height:34px;border-radius:50%;
      display:block;object-fit:cover;
      box-shadow:0 6px 18px rgba(20,16,40,.18)
    }
    .logo-fallback{
      width:34px;height:34px;border-radius:50%;display:grid;place-items:center;
      color:#fff;font-weight:800;background:#173a86;box-shadow:0 6px 18px rgba(20,16,40,.18)
    }
    header.app h1{font-size:18px;margin:0;font-weight:700}

    /* Bot√µes */
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;
      color:#fff;background:linear-gradient(135deg,var(--p1),var(--p2));
      box-shadow:0 6px 18px rgba(20,16,40,.12)
    }
    .btn.secondary{background:#f1efff;color:#3a2c8c}
    .btn.ghost{background:transparent;color:#3a2c8c;border:1px solid #ded8ff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Cards */
    .card{
      background:rgba(255,255,255,.95);border:1px solid var(--stroke);border-radius:var(--r);
      padding:16px;margin-top:14px;box-shadow:var(--shadow)
    }

    /* Tarja superior (igual ao print) */
    .card-header-bar{
      margin:-6px -6px 14px -6px;padding:12px 14px;border-radius:10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45)),
        linear-gradient(135deg, #2c3ea8 0%, #6226c7 45%, #7b3af2 100%);
      border:1px solid rgba(255,255,255,.55);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.7), 0 2px 10px rgba(20,16,40,.10);
      display:flex;align-items:center;gap:10px
    }
    .card-header-bar .dot{
      width:18px;height:18px;border-radius:50%;display:grid;place-items:center;
      color:#7b3af2;background:#fff;box-shadow:0 1px 4px rgba(20,16,40,.15);font-size:12px
    }
    .card-header-bar .title{
      color:#fff;font-weight:700;letter-spacing:.2px;text-shadow:0 1px 1px rgba(0,0,0,.25)
    }

    /* Grid */
    .grid{display:grid;gap:14px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:980px){.cols-3,.cols-4{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}

    /* Inputs */
    label{font-size:12px;color:#767398;display:block;margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{
      width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fbfaff;outline:none
    }
    textarea{min-height:64px;resize:vertical}

    /* Toggle OFFSET/DIGITAL */
    .toggle{display:flex;gap:10px}
    .toggle .btn{
      background:#fff;color:#3a2c8c;border:1px solid #e6e3f2;
      box-shadow:0 2px 8px rgba(20,16,40,.06)
    }
    .toggle .btn.active{
      background:#fff;border-color:#d6d1ff;
      box-shadow:inset 0 0 0 2px #edeaff, 0 2px 10px rgba(20,16,40,.08);
      position:relative
    }
    .toggle .btn.active::after{
      content:'';position:absolute;inset:0;border-radius:12px;
      background:radial-gradient(60% 100% at 0% 0%, rgba(123,58,242,.15), transparent 60%),
                 radial-gradient(50% 80% at 100% 0%, rgba(62,139,255,.15), transparent 60%)
    }

    /* Imagens (Ctrl+V) */
    .dropzone{
      border:2px dashed #d7ceff;border-radius:12px;padding:22px;background:#fbfaff;text-align:center;color:#7b6ea8
    }
    .paste-capture{
      position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;
    }
    .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .thumb{width:110px;height:110px;border-radius:10px;overflow:hidden;position:relative;background:#f1edff;box-shadow:0 2px 10px rgba(20,16,40,.12)}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}

    /* Tabelas */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#7a7493;text-align:left;padding:0 10px}
    tbody tr{background:#fff;box-shadow:0 2px 10px rgba(20,16,40,.1)}
    tbody td{padding:8px 10px}

    /* Resumo fixo inferior */
    .summary{position:fixed;left:0;right:0;bottom:0;padding:12px 0;background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.2));backdrop-filter:blur(6px)}
    .summary .wrap{
      display:grid;grid-template-columns:repeat(7, 1fr) 260px; gap:10px;margin:0 auto
    }
    .kpi{background:rgba(255,255,255,.92);border-radius:12px;padding:10px;text-align:center;border:1px solid var(--stroke)}
    .kpi .k{font-size:12px;color:#6f6a86}
    .kpi .v{font-size:16px;font-weight:800;margin-top:4px}
    .right{display:flex;gap:10px;justify-content:flex-end;align-items:center}

    /* Rodap√© da marca */
    .brand-footer{
      margin:18px 0 80px;text-align:center;color:#e9e6ffcc;font-size:12px;font-weight:700
    }

    /* Impress√£o */
    @media print{
      body{background:#fff}
      .drawer{display:none !important}
      .wrap{margin:0}
      .card{box-shadow:none}
      .summary{position:static;background:transparent;padding:8px 0}
      .summary .wrap{grid-template-columns:repeat(7, 1fr)}
      .right{display:none}
      @page { size: A4; margin: 12mm }
    }

    /* Drawer (Valores Base) */
    .drawer{position:fixed; inset:0; background:rgba(12,8,30,.45); display:none; align-items:stretch}
    .drawer.open{display:flex}
    .drawer .panel{
      margin-left:auto; width:min(880px, 92%); background:#fff; height:100%;
      border-top-left-radius:18px; border-bottom-left-radius:18px; box-shadow:-8px 0 28px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
    }
    .panel header{padding:16px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:12px}
    .panel main{padding:16px; overflow:auto}
    .panel footer{padding:12px 16px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end}

    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid #e7e1ff; background:#f8f7ff; color:#5a46ff; cursor:pointer; font-weight:700}
    .tab.active{background: linear-gradient(135deg, #6d4bff, #3e8bff); color:#fff}
    .small{font-size:12px; color:#7a7194}
  </style>
</head>
<body>
  <div class="wrap" id="printRoot">
    <!-- Header -->
    <header class="app">
      ./logo-digra.pngDG</div>'" />
      <h1>Or√ßamento Gr√°fico</h1>
      <div style="flex:1"></div>
      <button id="btnEditBase" class="btn secondary">‚öôÔ∏è Editar Valores Base</button>
      <span></span>
      <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir / Salvar PDF</button>
    </header>

    <!-- Informa√ß√µes Iniciais -->
    <section class="card" id="cardInfo">
      <div class="card-header-bar"><div class="dot">üßæ</div><div class="title">Informa√ß√µes Iniciais</div></div>
      <div class="grid cols-3">
        <div>
          <label>Quantidade Total de Itens *</label>
          <input type="number" id="qtdItens" min="1" value="1000" />
        </div>
        <div>
          <label>Tamanho Final do Produto *</label>
          <input type="text" id="tamFinal" placeholder="Ex.: 10x15cm" />
        </div>
        <div>
          <label>Tecnologia de Impress√£o *</label>
          <div class="toggle" role="group" aria-label="Tecnologia de Impress√£o">
            <button class="btn" id="btnOffset" type="button">‚öôÔ∏è OFFSET</button>
            <button class="btn secondary" id="btnDigital" type="button">üñ®Ô∏è DIGITAL</button>
          </div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Descri√ß√£o do Servi√ßo</label>
          <textarea id="desc"></textarea>
        </div>
        <div>
          <label>Dados T√©cnicos</label>
          <textarea id="dadosTec"></textarea>
        </div>
      </div>
    </section>

    <!-- Imagens do Projeto (Ctrl+V / DnD) -->
    <section class="card" id="cardImgs">
      <div class="card-header-bar"><div class="dot">üñºÔ∏è</div><div class="title">Imagens do Projeto</div></div>
      <div class="dropzone" id="dropzone" tabindex="0">
        <div style="font-size:28px;margin-bottom:8px">üñºÔ∏è</div>
        <div>Clique aqui e cole suas imagens (Ctrl+V)</div>
        <div class="small">Voc√™ pode colar m√∫ltiplas imagens ‚Ä¢ tamb√©m aceita arrastar e soltar</div>
        <div class="paste-capture" id="pasteCapture" contenteditable="true"></div>
      </div>
      <div class="thumbs" id="thumbs"></div>
    </section>

    <!-- Pap√©is Utilizados -->
    <section class="card" id="cardPapeis">
      <div class="card-header-bar"><div class="dot">üìÑ</div><div class="title">Pap√©is Utilizados</div></div>
      <button class="btn ghost" type="button" id="addPapel">+ Adicionar Papel</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Papel</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ por unidade</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblPapeis"></tbody>
      </table>
    </section>

    <!-- Materiais Utilizados -->
    <section class="card" id="cardMateriais">
      <div class="card-header-bar"><div class="dot">üõ†Ô∏è</div><div class="title">Materiais Utilizados</div></div>
      <button class="btn ghost" type="button" id="addMaterial">+ Adicionar Material</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:24%">Material</th>
            <th style="width:18%">Tipo</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMateriais"></tbody>
      </table>
    </section>

    <!-- Impress√£o Digital -->
    <section class="card" id="cardImp">
      <div class="card-header-bar"><div class="dot">üñ®Ô∏è</div><div class="title">Impress√£o Digital</div></div>
      <button class="btn ghost" type="button" id="addImp">+ Adicionar Impress√£o</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:26%">Tipo</th>
            <th style="width:14%">Formato</th>
            <th style="width:12%">Quantidade</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblImp"></tbody>
      </table>
    </section>

    <!-- M√£o de Obra -->
    <section class="card" id="cardMO">
      <div class="card-header-bar"><div class="dot">üë•</div><div class="title">M√£o de Obra</div></div>
      <button class="btn ghost" type="button" id="addMao">+ Adicionar Profissional</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Profissional</th>
            <th style="width:14%">Horas</th>
            <th style="width:14%">R$ / hora</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMao"></tbody>
      </table>
    </section>

    <!-- Rodap√© de marca (mostra tamb√©m no PDF) -->
    <div class="brand-footer">‚ö° Alexandre | DIGRA Apps</div>
  </div>

  <!-- Resumo (agora imprime tamb√©m) -->
  <div class="summary">
    <div class="wrap">
      <div class="kpi"><div class="k">Pap√©is</div><div class="v" id="kPap">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Materiais</div><div class="v" id="kMat">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Impress√£o</div><div class="v" id="kImp">R$ 0,00</div></div>
      <div class="kpi"><div class="k">M√£o de Obra</div><div class="v" id="kMao">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Acr√©sc. 10%</div><div class="v" id="kAc">R$ 0,00</div></div>
      <div class="kpi"><div class="k">TOTAL GERAL</div><div class="v" id="kTot">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Valor Unit√°rio</div><div class="v" id="kUni">R$ 0,00</div></div>
      <div class="right">
        <button class="btn secondary" id="btnEditBase2">‚öôÔ∏è Valores Base</button>
        <button class="btn" id="btnPrint2">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Drawer de Valores Base -->
  <div class="drawer" id="drawer">
    <div class="panel">
      <header>
        <strong>‚öôÔ∏è Valores Base e Configura√ß√µes</strong>
        <div style="flex:1"></div>
        <button class="btn ghost" id="btnCloseDrawer">Fechar</button>
      </header>
      <main>
        <div class="tabs">
          <button class="tab active" data-tab="papeis">Pap√©is</button>
          <button class="tab" data-tab="materiais">Materiais</button>
          <button class="tab" data-tab="imp">Impress√£o Digital</button>
          <button class="tab" data-tab="mao">M√£o de Obra</button>
          <span style="flex:1"></span>
          <button class="btn ghost" id="btnExport">Exportar JSON</button>
          <label class="btn ghost" for="importJson" style="cursor:pointer;">Importar JSON</label>
          <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </div>

        <!-- Pap√©is -->
        <section data-pane="papeis">
          <div class="small" style="margin-bottom:8px">
            Valores exatos (Pacote 66√ó96, Folha, A3, A4). ‚ÄúFolhas/Pacote‚Äù s√≥ √© usado se precisar converter.
          </div>
          <table>
            <thead><tr><th>Nome do Papel</th><th>R$ A4</th><th>R$ A3</th><th>R$ Folha</th><th>R$ Pacote</th><th>Folhas/Pacote</th><th>A√ß√µes</th></tr></thead>
            <tbody id="basePapeis"></tbody>
          </table>
          <button class="btn ghost" id="baseAddPapel" style="margin-top:10px">+ Adicionar Papel</button>
        </section>

        <!-- Materiais -->
        <section data-pane="materiais" style="display:none">
          <div class="small" style="margin-bottom:8px">Deixe o ‚ÄúTipo‚Äù vazio quando o item j√° for espec√≠fico (ex.: ‚ÄúEspiral 7‚ÄØmm‚Äù).</div>
          <table>
            <thead><tr><th>Material</th><th>Tipos (",")</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMateriais"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMaterial" style="margin-top:10px">+ Adicionar Material</button>
        </section>

        <!-- Impress√£o Digital -->
        <section data-pane="imp" style="display:none">
          <div class="small" style="margin-bottom:8px">Somente A4 e A3 com tipos humanizados.</div>
          <table>
            <thead><tr><th>Tipo</th><th>Formato</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseImp"></tbody>
          </table>
          <button class="btn ghost" id="baseAddImp" style="margin-top:10px">+ Adicionar Impress√£o</button>
        </section>

        <!-- M√£o de Obra -->
        <section data-pane="mao" style="display:none">
          <table>
            <thead><tr><th>Profissional</th><th>R$ por Hora</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMao"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMao" style="margin-top:10px">+ Adicionar Profissional</button>
        </section>
      </main>
      <footer>
        <button class="btn secondary" id="btnResetBase">‚Ü∫ Restaurar Padr√µes</button>
        <button class="btn" id="btnSaveBase">üíæ Salvar Altera√ß√µes</button>
      </footer>
    </div>
  </div>

  <script>
  (function(){
    const fmt = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    // ===== Base oficial (a partir dos dados que voc√™ enviou) =====
    const STORAGE = { base:'digra.base.v2' };

    const DEFAULT_BASE = {
      papeis: [
        {nome:'ADESIVO FOSCO - 180g', pacote:296.64, folha:2.97, a3:0.74, a4:0.33, folhasPacote:100},  // folhasPacote n√£o √© usado, mas deixo um n√∫mero
        {nome:'CART√ÉO TRIPLEX - 250g', pacote:475.00, folha:3.17, a3:0.79, a4:0.35, folhasPacote:150},
        {nome:'CARTOLINA BRANCA - 180g', pacote:114.00, folha:1.14, a3:0.57, a4:0.29, folhasPacote:100},
        {nome:'CARTOLINA BRANCA - 240g', pacote:95.00, folha:0.95, a3:0.48, a4:0.24, folhasPacote:100},
        {nome:'COUCH√ä 115g', pacote:192.00, folha:0.77, a3:0.19, a4:0.09, folhasPacote:250},
        {nome:'COUCH√ä 150g', pacote:169.45, folha:0.68, a3:0.17, a4:0.08, folhasPacote:250},
        {nome:'COUCH√ä 210g', pacote:256.69, folha:1.71, a3:0.43, a4:0.19, folhasPacote:150},
        {nome:'KRAFT 110g', pacote:241.84, folha:0.97, a3:0.24, a4:0.11, folhasPacote:250},
        {nome:'OPALINE 180g', pacote:114.00, folha:1.68, a3:0.42, a4:0.19, folhasPacote:100},
        {nome:'OFFSET 75g', pacote:132.00, folha:0.53, a3:0.13, a4:0.06, folhasPacote:250},
        {nome:'OFFSET 90g', pacote:236.71, folha:0.47, a3:0.12, a4:0.05, folhasPacote:500},
        {nome:'OFFSET 120g', pacote:200.01, folha:0.80, a3:0.20, a4:0.09, folhasPacote:250},
        {nome:'VERG√ä 80g', pacote:98.64, folha:0.39, a3:0.10, a4:0.04, folhasPacote:250},
        {nome:'VERG√ä 180g', pacote:139.49, folha:1.12, a3:0.28, a4:0.12, folhasPacote:125},

        // Papel para m√°quina digital (valores por folha em tamanhos espec√≠ficos)
        {nome:'PAPEL DIGITAL OFFSET 75g - Of√≠cio II (folha)', pacote:14.90, folha:0.0298, a3:0, a4:0, folhasPacote:500},
        {nome:'PAPEL DIGITAL OFFSET 75g - A4 (folha)',       pacote:19.91, folha:0.0398, a3:0, a4:0.0398, folhasPacote:500},
        {nome:'PAPEL DIGITAL OFFSET 75g - A3 (folha)',       pacote:61.70, folha:0.1234, a3:0.1234, a4:0, folhasPacote:500},
      ],

      // Materiais com unidade expl√≠cita
      materiais: [
        // LASER FILME
        {nome:'Lazer Filme A3 (folha)', tipos:'', valor:3.57},
        {nome:'Lazer Filme Of√≠cio II (folha)', tipos:'', valor:1.90},

        // CHAPA OFFSET POSITIVA
        {nome:'Chapa Offset Positiva SAKURAI 400√ó520√ó0,30 (un)', tipos:'', valor:7.58},
        {nome:'Chapa Offset Positiva HEIDELBERG 459√ó525√ó0,15 (un)', tipos:'', valor:14.00},

        // CTP
        {nome:'Chapa Offset T√©rmica Digital (CTP) SAKURAI (un)', tipos:'', valor:57.00},
        {nome:'Chapa Offset T√©rmica Digital (CTP) HEIDELBERG (un)', tipos:'', valor:54.50},

        // Espirais (unidade)
        {nome:'Espiral 7 mm (un)', tipos:'', valor:0.11},
        {nome:'Espiral 9 mm (un)', tipos:'', valor:0.13},
        {nome:'Espiral 12 mm (un)', tipos:'', valor:0.28},
        {nome:'Espiral 14 mm (un)', tipos:'', valor:0.36},
        {nome:'Espiral 17 mm (un)', tipos:'', valor:0.44},
        {nome:'Espiral 20 mm (un)', tipos:'', valor:0.64},
        {nome:'Espiral 23 mm (un)', tipos:'', valor:0.75},
        {nome:'Espiral 25 mm (un)', tipos:'', valor:0.98},
        {nome:'Espiral 29 mm (un)', tipos:'', valor:1.25},
        {nome:'Espiral 33 mm (un)', tipos:'', valor:1.52},
        {nome:'Espiral 40 mm (un)', tipos:'', valor:1.70},
        {nome:'Espiral 45 mm (un)', tipos:'', valor:2.37},
        {nome:'Espiral 50 mm (un)', tipos:'', valor:3.16},

        // Capa PP (unidade)
        {nome:'Capa PP 0,30 Transparente (un)', tipos:'', valor:0.40},
        {nome:'Capa PP 0,30 Preta (un)', tipos:'', valor:0.30},

        // Fita dupla face (cm)
        {nome:'Fita Dupla Face 19 mm (cm)', tipos:'', valor:0.0050},
        {nome:'Fita Dupla Face 25 mm (cm)', tipos:'', valor:0.0043},
        {nome:'Fita Dupla Face 50 mm (cm)', tipos:'', valor:0.0086},

        // Bobina polietileno (cm)
        {nome:'Bobina Polietileno 34cm√ó0,05mm√ó60m (cm)', tipos:'', valor:0.0342},

        // Vinil (metro)
        {nome:'Adesivo Vinil Preto (m)', tipos:'', valor:14.40},
        {nome:'Adesivo Vinil Azul M√©dio (m)', tipos:'', valor:15.86},
        {nome:'Adesivo Vinil Vermelho M√©dio (m)', tipos:'', valor:18.31},
        {nome:'Adesivo Vinil Transparente (m)', tipos:'', valor:9.90},
        {nome:'M√°scara de Transfer√™ncia (m)', tipos:'', valor:17.11},

        // Bolsa para pastas (un)
        {nome:'Bolsa para Pastas 240g + Fita 19mm 25√ó11 (un)', tipos:'', valor:0.27},
      ],

      imps: [
        // 1/0
        {tipo:'Frente 1 cor', formato:'A4', valor:0.03},
        {tipo:'Frente 1 cor', formato:'A3', valor:0.06},
        // 1/1
        {tipo:'Frente e verso 1 cor', formato:'A4', valor:0.06},
        {tipo:'Frente e verso 1 cor', formato:'A3', valor:0.12},
        // 4/0
        {tipo:'Frente colorida', formato:'A4', valor:0.25},
        {tipo:'Frente colorida', formato:'A3', valor:0.46},
        // 4/4
        {tipo:'Frente e verso colorido', formato:'A4', valor:0.50},
        {tipo:'Frente e verso colorido', formato:'A3', valor:0.92}
      ],

      mao: [
        {prof:'Coordenador de Artes Gr√°ficas', valorHora:85.67},
        {prof:'Designer Gr√°fico', valorHora:65.00},
        {prof:'Or√ßamentista Gr√°fico', valorHora:41.37},
        {prof:'Mestre Impressor', valorHora:53.84},
        {prof:'Impressor Digital', valorHora:36.00},
        {prof:'Mestre Impressor Offset', valorHora:53.84},
        {prof:'Impressor Offset', valorHora:36.00},
        {prof:'Operador de Guilhotina', valorHora:36.00},
        {prof:'Mestre de Servi√ßos Gr√°ficos', valorHora:53.84},
        {prof:'Operador de Acabamento Gr√°fico', valorHora:36.00},
        {prof:'Encarregado', valorHora:53.84}
      ]
    };

    function loadBase(){
      try{ return JSON.parse(localStorage.getItem(STORAGE.base)) || JSON.parse(JSON.stringify(DEFAULT_BASE)); }
      catch(e){ return JSON.parse(JSON.stringify(DEFAULT_BASE)); }
    }
    function saveBase(b){ localStorage.setItem(STORAGE.base, JSON.stringify(b)); }

    let base = loadBase();

    // ===== Estado =====
    const state = { tecnologia:'DIGITAL' };

    // ===== OFFSET/DIGITAL =====
    const btnOffset = $('#btnOffset'), btnDigital = $('#btnDigital');
    function setTec(t){
      state.tecnologia = t;
      btnOffset.classList.toggle('active', t==='OFFSET');
      btnOffset.classList.toggle('secondary', t!=='OFFSET');
      btnDigital.classList.toggle('active', t==='DIGITAL');
      btnDigital.classList.toggle('secondary', t!=='DIGITAL');
      recalc();
    }
    btnOffset.onclick = ()=> setTec('OFFSET');
    btnDigital.onclick = ()=> setTec('DIGITAL');
    setTec('DIGITAL');

    // ===== PAP√âIS =====
    const tbP = $('#tblPapeis');
    $('#addPapel').onclick = addRowPapel;

    function addRowPapel(){
      const tr = document.createElement('tr');

      const selP = document.createElement('select');
      base.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; selP.appendChild(o); });

      const selT = document.createElement('select');
      ['A4','A3','Folha','Pacote'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selT.appendChild(o); });

      const qtd = document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='100';
      const val = document.createElement('input'); val.type='number'; val.min='0'; val.step='0.01';
      const tdTotal = document.createElement('td'); tdTotal.textContent = fmt.format(0);
      const delTd = document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; delTd.appendChild(del);

      const td1=document.createElement('td'); td1.appendChild(selP);
      const td2=document.createElement('td'); td2.appendChild(selT);
      const td3=document.createElement('td'); td3.appendChild(qtd);
      const td4=document.createElement('td'); td4.appendChild(val);

      tr.append(td1, td2, td3, td4, tdTotal, delTd);
      tbP.appendChild(tr);

      function syncVal(){
        const p = base.papeis.find(x=>x.nome===selP.value);
        const key = selT.value.toLowerCase(); // a4,a3,folha,pacote
        let unit = 0;
        if(p && typeof p[key]==='number') unit = p[key];
        else if(p){
          if(key==='a4' && p.folha) unit = p.folha/4;
          else if(key==='a3' && p.folha) unit = p.folha/2;
          else if(key==='folha' && p.pacote && p.folhasPacote) unit = p.pacote/p.folhasPacote;
        }
        val.value = Number(unit||0).toFixed(2);
        update();
      }
      function update(){
        const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
        tdTotal.textContent = fmt.format(c);
        recalc();
      }

      selP.onchange=syncVal; selT.onchange=syncVal; qtd.oninput=update; val.oninput=update;
      del.onclick=()=>{ tr.remove(); recalc(); };
      syncVal();
    }

    // ===== MATERIAIS =====
    const tbM = $('#tblMateriais');
    $('#addMaterial').onclick = addRowMaterial;

    function addRowMaterial(){
      const tr = document.createElement('tr');

      const sel = document.createElement('select');
      base.materiais.forEach(m=>{ const o=document.createElement('option'); o.value=m.nome; o.textContent=m.nome; sel.appendChild(o); });

      const tipo = document.createElement('select'); // opcional
      const tam  = document.createElement('input'); tam.type='text';
      const qtd  = document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='1';
      const val  = document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0';
      const tdTotal = document.createElement('td'); tdTotal.textContent = fmt.format(0);
      const delTd = document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; delTd.appendChild(del);

      const td1=document.createElement('td'); td1.appendChild(sel);
      const td2=document.createElement('td'); td2.appendChild(tipo);
      const td3=document.createElement('td'); td3.appendChild(tam);
      const td4=document.createElement('td'); td4.appendChild(qtd);
      const td5=document.createElement('td'); td5.appendChild(val);

      tr.append(td1,td2,td3,td4,td5,tdTotal,delTd);
      tbM.appendChild(tr);

      function fill(){
        const def = base.materiais.find(x=>x.nome===sel.value);
        // aqui 'tipos' √© apenas texto informativo quando preciso; valor muda manualmente se desejar
        tipo.innerHTML='';
        const list = (def?.tipos||'').split(',').map(s=>s.trim()).filter(Boolean);
        if(list.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='‚Äî'; tipo.appendChild(o); }
        else list.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; tipo.appendChild(o); });
        val.value = (def?.valor||0).toFixed(4);
        upd();
      }
      function upd(){
        const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
        tdTotal.textContent = fmt.format(c);
        recalc();
      }
      sel.onchange=fill; qtd.oninput=upd; val.oninput=upd; del.onclick=()=>{ tr.remove(); recalc(); };
      fill();
    }

    // ===== IMPRESS√ÉO DIGITAL =====
    const tbI = $('#tblImp');
    $('#addImp').onclick = addRowImp;

    function addRowImp(){
      const tr = document.createElement('tr');

      const tipos = [...new Set(base.imps.map(i=>i.tipo))];
      const selTipo = document.createElement('select'); tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });

      const selFmt  = document.createElement('select');
      const qtd     = document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='100';
      const val     = document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0';
      const tdTotal = document.createElement('td'); tdTotal.textContent = fmt.format(0);
      const delTd   = document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; delTd.appendChild(del);

      const td1=document.createElement('td'); td1.appendChild(selTipo);
      const td2=document.createElement('td'); td2.appendChild(selFmt);
      const td3=document.createElement('td'); td3.appendChild(qtd);
      const td4=document.createElement('td'); td4.appendChild(val);

      tr.append(td1,td2,td3,td4,tdTotal,delTd);
      tbI.appendChild(tr);

      function fillFmt(){
        selFmt.innerHTML='';
        const formatos = base.imps.filter(x=>x.tipo===selTipo.value).map(x=>x.formato).filter(f=>f==='A4'||f==='A3');
        [...new Set(formatos)].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFmt.appendChild(o); });
        syncVal();
      }
      function syncVal(){
        const it = base.imps.find(x=>x.tipo===selTipo.value && x.formato===selFmt.value);
        val.value = (it? it.valor:0).toFixed(2);
        upd();
      }
      function upd(){
        const c = (parseFloat(val.value)||0) * (parseFloat(qtd.value)||0);
        tdTotal.textContent = fmt.format(c);
        recalc();
      }

      selTipo.onchange=fillFmt; selFmt.onchange=syncVal; qtd.oninput=upd; val.oninput=upd;
      del.onclick=()=>{ tr.remove(); recalc(); };
      fillFmt();
    }

    // ===== M√ÉO DE OBRA =====
    const tbO = $('#tblMao');
    $('#addMao').onclick = addRowMao;

    function addRowMao(){
      const tr = document.createElement('tr');

      const sel = document.createElement('select');
      base.mao.forEach(m=>{ const o=document.createElement('option'); o.value=m.prof; o.textContent=m.prof; sel.appendChild(o); });

      const horas = document.createElement('input'); horas.type='number'; horas.min='0.25'; horas.step='0.25'; horas.value='1';
      const val   = document.createElement('input'); val.type='number'; val.step='0.01'; val.min='0';
      const tdTot = document.createElement('td'); tdTot.textContent = fmt.format(0);
      const delTd = document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; delTd.appendChild(del);

      const td1=document.createElement('td'); td1.appendChild(sel);
      const td2=document.createElement('td'); td2.appendChild(horas);
      const td3=document.createElement('td'); td3.appendChild(val);

      tr.append(td1,td2,td3,tdTot,delTd);
      tbO.appendChild(tr);

      function sync(){ const def=base.mao.find(x=>x.prof===sel.value); val.value=(def?.valorHora||0).toFixed(2); upd(); }
      function upd(){ const c=(parseFloat(horas.value)||0)*(parseFloat(val.value)||0); tdTot.textContent=fmt.format(c); recalc(); }

      sel.onchange=sync; horas.oninput=upd; val.oninput=upd; del.onclick=()=>{ tr.remove(); recalc(); };
      sync();
    }

    // ===== Resumo / C√°lculo =====
    function recalc(){
      const sumP = Array.from($('#tblPapeis').querySelectorAll('tr')).reduce((acc,tr)=>{
        const q=parseFloat(tr.children[2].querySelector('input').value)||0;
        const v=parseFloat(tr.children[3].querySelector('input').value)||0;
        const c=q*v; tr.children[4].textContent=fmt.format(c); return acc+c;
      },0);
      const sumM = Array.from($('#tblMateriais').querySelectorAll('tr')).reduce((acc,tr)=>{
        const q=parseFloat(tr.children[3].querySelector('input').value)||0;
        const v=parseFloat(tr.children[4].querySelector('input').value)||0;
        const c=q*v; tr.children[5].textContent=fmt.format(c); return acc+c;
      },0);
      const sumI = Array.from($('#tblImp').querySelectorAll('tr')).reduce((acc,tr)=>{
        const q=parseFloat(tr.children[2].querySelector('input').value)||0;
        const v=parseFloat(tr.children[3].querySelector('input').value)||0;
        const c=q*v; tr.children[4].textContent=fmt.format(c); return acc+c;
      },0);
      const sumO = Array.from($('#tblMao').querySelectorAll('tr')).reduce((acc,tr)=>{
        const h=parseFloat(tr.children[1].querySelector('input').value)||0;
        const v=parseFloat(tr.children[2].querySelector('input').value)||0;
        const c=h*v; tr.children[3].textContent=fmt.format(c); return acc+c;
      },0);

      const acresc = (state.tecnologia==='OFFSET') ? 0.10*(sumP+sumM) : 0;
      const total  = sumP + sumM + sumI + sumO + acresc;

      $('#kPap').textContent = fmt.format(sumP);
      $('#kMat').textContent = fmt.format(sumM);
      $('#kImp').textContent = fmt.format(sumI);
      $('#kMao').textContent = fmt.format(sumO);
      $('#kAc' ).textContent = fmt.format(acresc);
      $('#kTot').textContent = fmt.format(total);

      const itens = Math.max(1, parseInt($('#qtdItens').value||'1',10));
      $('#kUni').textContent = fmt.format(total / itens);
    }
    $('#qtdItens').addEventListener('input', recalc);

    // ===== Imagens: Ctrl+V / DnD robusto =====
    const dz   = $('#dropzone'), thumbs = $('#thumbs'), cap = $('#pasteCapture');
    function addImg(url){
      const div=document.createElement('div'); div.className='thumb';
      const img=new Image(); img.src=url; div.appendChild(img);
      const x=document.createElement('button'); x.textContent='‚úñ'; x.title='Remover'; x.onclick=()=>div.remove();
      div.appendChild(x); thumbs.appendChild(div);
    }
    function handleItems(items){
      const list = Array.from(items||[]);
      let ok=false;
      for(const it of list){
        if(it.type && it.type.startsWith('image/')){
          const f = it.getAsFile ? it.getAsFile() : it;
          if(f){ const url = URL.createObjectURL(f); addImg(url); ok=true; }
        }
      }
      return ok;
    }
    // alvo contenteditable para browsers que exigem foco
    dz.addEventListener('click', ()=> { cap.focus(); });
    dz.addEventListener('paste', (e)=>{ if(handleItems(e.clipboardData?.items)){ e.preventDefault(); }});
    cap.addEventListener('paste', (e)=>{ if(handleItems(e.clipboardData?.items)){ e.preventDefault(); }});
    document.addEventListener('paste', (e)=>{ // fallback global
      if(document.activeElement!==cap && document.activeElement!==dz){
        handleItems(e.clipboardData?.items);
      }
    });
    dz.addEventListener('dragover', e=>{ e.preventDefault(); });
    dz.addEventListener('drop', e=>{ e.preventDefault(); handleItems(e.dataTransfer?.files); });

    // ===== PRINT (A4, 1‚Äì2 p√°ginas, com KPIs e rodap√©) =====
    function printScaled(){
      const root = document.getElementById('printRoot');
      // medir A4
      const probe = document.createElement('div');
      probe.style.width='210mm'; probe.style.height='297mm'; probe.style.position='absolute'; probe.style.visibility='hidden';
      document.body.appendChild(probe);
      const a4h = probe.getBoundingClientRect().height; document.body.removeChild(probe);

      const totalHeight = document.body.scrollHeight;
      const max = a4h*2 - 24;
      const scale = totalHeight > max ? Math.max(0.7, max/totalHeight) : 1;

      const html = document.documentElement;
      const oldZoom = html.style.zoom;
      html.style.zoom = scale.toString();
      setTimeout(()=>{ window.print(); setTimeout(()=>{ html.style.zoom = oldZoom; }, 100); }, 80);
    }
    $('#btnPrint').onclick = printScaled;
    $('#btnPrint2').onclick = printScaled;

    // ===== Drawer (Base) =====
    const drawer = $('#drawer');
    function openDrawer(){ renderBaseTables(); drawer.classList.add('open'); }
    function closeDrawer(){ drawer.classList.remove('open'); }
    $('#btnEditBase').onclick = openDrawer;
    $('#btnEditBase2').onclick = openDrawer;
    $('#btnCloseDrawer').onclick = closeDrawer;

    $$('.tab').forEach(tab=> tab.addEventListener('click', ()=>{
      $$('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active');
      const pane = tab.dataset.tab;
      $$('[data-pane]').forEach(p=> p.style.display = (p.getAttribute('data-pane')===pane)?'block':'none');
    }));

    function rowDelButton(onClick){
      const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn ghost'; b.textContent='Remover'; b.onclick=onClick; td.appendChild(b); return td;
    }

    function renderBaseTables(){
      // Pap√©is
      const tbP = $('#basePapeis'); tbP.innerHTML='';
      base.papeis.forEach((p,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${p.nome}"></td>
          <td><input type="number" step="0.01" value="${p.a4||0}"></td>
          <td><input type="number" step="0.01" value="${p.a3||0}"></td>
          <td><input type="number" step="0.01" value="${p.folha||0}"></td>
          <td><input type="number" step="0.01" value="${p.pacote||0}"></td>
          <td><input type="number" step="1" value="${p.folhasPacote||500}"></td>`;
        tr.appendChild(rowDelButton(()=>{ base.papeis.splice(idx,1); renderBaseTables(); syncPapelSelects(); }));
        tbP.appendChild(tr);
      });

      // Materiais
      const tbM = $('#baseMateriais'); tbM.innerHTML='';
      base.materiais.forEach((m,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${m.nome}"></td>
          <td><input value="${m.tipos||''}"></td>
          <td><input type="number" step="0.0001" value="${m.valor}"></td>`;
        tr.appendChild(rowDelButton(()=>{ base.materiais.splice(idx,1); renderBaseTables(); syncMaterialSelects(); }));
        tbM.appendChild(tr);
      });

      // Impress√£o Digital
      const tbI = $('#baseImp'); tbI.innerHTML='';
      base.imps.forEach((i,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${i.tipo}"></td>
          <td><select>
                <option ${i.formato==='A4'?'selected':''}>A4</option>
                <option ${i.formato==='A3'?'selected':''}>A3</option>
              </select></td>
          <td><input type="number" step="0.01" value="${i.valor}"></td>`;
        tr.appendChild(rowDelButton(()=>{ base.imps.splice(idx,1); renderBaseTables(); }));
        tbI.appendChild(tr);
      });

      // M√£o de Obra
      const tbO = $('#baseMao'); tbO.innerHTML='';
      base.mao.forEach((o,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${o.prof}"></td>
          <td><input type="number" step="0.01" value="${o.valorHora}"></td>`;
        tr.appendChild(rowDelButton(()=>{ base.mao.splice(idx,1); renderBaseTables(); syncMaoSelects(); }));
        tbO.appendChild(tr);
      });
    }

    // Add itens
    $('#baseAddPapel').onclick   = ()=>{ base.papeis.push({nome:'Novo Papel', a4:0, a3:0, folha:0, pacote:0, folhasPacote:500}); renderBaseTables(); syncPapelSelects(); };
    $('#baseAddMaterial').onclick= ()=>{ base.materiais.push({nome:'Novo Material', tipos:'', valor:0}); renderBaseTables(); syncMaterialSelects(); };
    $('#baseAddImp').onclick     = ()=>{ base.imps.push({tipo:'Frente 1 cor', formato:'A4', valor:0}); renderBaseTables(); };
    $('#baseAddMao').onclick     = ()=>{ base.mao.push({prof:'Novo Profissional', valorHora:0}); renderBaseTables(); syncMaoSelects(); };

    // Salvar base
    $('#btnSaveBase').onclick = ()=>{
      function rows(sel){ return $$('#'+sel+' tr'); }
      base.papeis = rows('basePapeis').map(tr=>({
        nome: tr.children[0].querySelector('input').value.trim(),
        a4: Number(tr.children[1].querySelector('input').value||0),
        a3: Number(tr.children[2].querySelector('input').value||0),
        folha: Number(tr.children[3].querySelector('input').value||0),
        pacote: Number(tr.children[4].querySelector('input').value||0),
        folhasPacote: Number(tr.children[5].querySelector('input').value||0)||500
      }));
      base.materiais = rows('baseMateriais').map(tr=>({
        nome: tr.children[0].querySelector('input').value.trim(),
        tipos: tr.children[1].querySelector('input').value.trim(),
        valor: Number(tr.children[2].querySelector('input').value||0)
      }));
      base.imps = rows('baseImp').map(tr=>({
        tipo: tr.children[0].querySelector('input').value.trim(),
        formato: tr.children[1].querySelector('select').value,
        valor: Number(tr.children[2].querySelector('input').value||0)
      }));
      base.mao = rows('baseMao').map(tr=>({
        prof: tr.children[0].querySelector('input').value.trim(),
        valorHora: Number(tr.children[1].querySelector('input').value||0)
      }));

      saveBase(base);
      syncAllSelects();
      recalc();
      alert('Valores base salvos.');
    };

    $('#btnResetBase').onclick = ()=>{
      if(confirm('Restaurar os valores padr√£o oficiais?')){
        base = JSON.parse(JSON.stringify(DEFAULT_BASE));
        saveBase(base);
        renderBaseTables(); syncAllSelects(); recalc();
      }
    };

    // Export / Import
    $('#btnExport').onclick = ()=>{
      const data = JSON.stringify(base, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='digra-valores-base.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#importJson').onchange = (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{
        try{ base=JSON.parse(r.result); saveBase(base); renderBaseTables(); syncAllSelects(); recalc(); alert('Importado com sucesso.'); }
        catch(err){ alert('Arquivo inv√°lido.'); }
      }; r.readAsText(f);
    };

    // Sync selects ap√≥s mudan√ßas na base
    function syncPapelSelects(){
      $$('#tblPapeis tr').forEach(tr=>{
        const sel = tr.children[0].querySelector('select'); const cur = sel.value;
        sel.innerHTML=''; base.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; sel.appendChild(o); });
        sel.value = base.papeis.some(p=>p.nome===cur)?cur:(base.papeis[0]?.nome||'');
        sel.dispatchEvent(new Event('change'));
      });
    }
    function syncMaterialSelects(){
      $$('#tblMateriais tr').forEach(tr=>{
        const sel = tr.children[0].querySelector('select'); const cur = sel.value;
        sel.innerHTML=''; base.materiais.forEach(m=>{ const o=document.createElement('option'); o.value=m.nome; o.textContent=m.nome; sel.appendChild(o); });
        sel.value = base.materiais.some(m=>m.nome===cur)?cur:(base.materiais[0]?.nome||'');
        const inpVal = tr.children[4].querySelector('input');
        const def = base.materiais.find(m=>m.nome===sel.value);
        inpVal.value = (def?.valor||0).toFixed(4);
        tr.children[5].textContent = fmt.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[3].querySelector('input').value)||0));
      });
    }
    function syncImpSelects(){
      $$('#tblImp tr').forEach(tr=>{
        const selTipo = tr.children[0].querySelector('select'); const cur = selTipo.value;
        selTipo.innerHTML=''; const tipos=[...new Set(base.imps.map(i=>i.tipo))];
        tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
        selTipo.value = tipos.includes(cur)?cur:(tipos[0]||'');

        const selFmt = tr.children[1].querySelector('select');
        selFmt.innerHTML='';
        const fmts = base.imps.filter(x=>x.tipo===selTipo.value).map(x=>x.formato).filter(f=>f==='A4'||f==='A3');
        [...new Set(fmts)].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFmt.appendChild(o); });

        const it = base.imps.find(x=>x.tipo===selTipo.value && x.formato===selFmt.value);
        const inpVal = tr.children[3].querySelector('input'); inpVal.value=(it?.valor||0).toFixed(2);
        tr.children[4].textContent = fmt.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[2].querySelector('input').value)||0));
      });
    }
    function syncMaoSelects(){
      $$('#tblMao tr').forEach(tr=>{
        const sel = tr.children[0].querySelector('select'); const cur = sel.value;
        sel.innerHTML=''; base.mao.forEach(m=>{ const o=document.createElement('option'); o.value=m.prof; o.textContent=m.prof; sel.appendChild(o); });
        sel.value = base.mao.some(m=>m.prof===cur)?cur:(base.mao[0]?.prof||'');
        const inpVal = tr.children[2].querySelector('input'); const def = base.mao.find(m=>m.prof===sel.value);
        inpVal.value = (def?.valorHora||0).toFixed(2);
        tr.children[3].textContent = fmt.format((parseFloat(inpVal.value)||0) * (parseFloat(tr.children[1].querySelector('input').value)||0));
      });
    }
    function syncAllSelects(){ syncPapelSelects(); syncMaterialSelects(); syncImpSelects(); syncMaoSelects(); }

    // Recalcular inicial
    recalc();
  })();
  </script>
</body>
</html>
