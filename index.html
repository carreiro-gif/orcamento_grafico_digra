<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Or√ßamento Gr√°fico ‚Ä¢ DIGRA</title>

<style>
  :root{
    /* Tema azul/verde fechado (sem roxo) */
    --bg1:#0a2040; --bg2:#0a2a3f; --bg3:#0b3141;
    --brand1:#0b4f6c; --brand2:#1b9aaa; /* bot√µes, detalhes */
    --ok:#16a34a; --warn:#f59e0b; --danger:#e11d48;
    --stroke:#e6e8ef; --muted:#77819a; --text:#1f2330;
    --white:#fff; --card:#ffffffee;
    --shadow:0 10px 30px rgba(8,18,35,.20);
    --r:14px; --rsm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background:
      radial-gradient(70% 90% at 0% -10%, #0a3155 0%, transparent 60%),
      radial-gradient(70% 90% at 100% -10%, #0e5a6a 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2) 55%, var(--bg3));
    background-attachment: fixed;
  }

  /* LAYOUT CENTRALIZADO E MAIS ESTREITO */
  .wrap{
    max-width: 980px; /* mais estreito e elegante */
    margin: 28px auto 120px;
    padding: 0 16px;
  }

  /* HEADER em gradiente para t√≠tulo branco */
  header.app{
    background: linear-gradient(135deg, #0b4f6c, #0d6a7a);
    color:#fff;
    border-radius:12px; padding:14px 18px;
    display:flex; gap:12px; align-items:center;
    box-shadow: var(--shadow);
  }
  header.app h1{margin:0; font-weight:700; font-size:18px; color:#fff}
  .logo-img{width:34px; height:34px; border-radius:50%; display:block; object-fit:cover; box-shadow:0 6px 18px rgba(10,20,35,.25)}
  .logo-fallback{width:34px;height:34px;border-radius:50%;display:none;place-items:center;background:#0e7490;color:#fff;font-weight:800}

  /* Cards */
  .card{
    background: var(--card);
    border:1px solid var(--stroke);
    border-radius: var(--r);
    padding: 16px;
    margin-top: 14px;
    box-shadow: var(--shadow);
  }

  /* Tarja gradiente em TODOS os cards (azul) */
  .card-header-bar{
    margin: -6px -6px 14px -6px;
    padding: 12px 14px;
    border-radius: 10px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45)),
      linear-gradient(135deg, #0b4f6c 0%, #0e6276 50%, #1483a1 100%);
    border: 1px solid rgba(255,255,255,.55);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 2px 10px rgba(10,20,35,.16);
    display:flex; align-items:center; gap:10px;
  }
  .card-header-bar .dot{
    width:18px; height:18px; border-radius:50%; display:grid; place-items:center;
    color:#0d6a7a; background:#fff; box-shadow:0 1px 4px rgba(10,20,35,.18); font-size:12px;
  }
  .card-header-bar .title{color:#ffffff; font-weight:800; letter-spacing:.2px; text-shadow:0 1px 1px rgba(0,0,0,.25)}

  /* Grid */
  .grid{display:grid; gap:14px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:980px){.cols-3,.cols-4{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}

  /* Inputs */
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text],input[type=number],textarea,select{
    width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#f7f9fc;outline:none
  }
  textarea{min-height:64px;resize:vertical}
  input::placeholder,textarea::placeholder{color:#9aa3b5}

  /* Bot√µes */
  .btn{
    appearance:none;border:0;border-radius:12px;padding:12px 16px;
    font-weight:800; cursor:pointer; color:#fff;
    background: linear-gradient(135deg,#0b4f6c,#1b9aaa);
    box-shadow: 0 6px 18px rgba(10,20,35,.16);
  }
  .btn.secondary{background:#eaf3f5; color:#0b4f6c; font-weight:700}
  .btn.ghost{background:transparent;color:#0b4f6c;border:1px solid #d9e3e7}

  /* OFFSET / DIGITAL (maiores, cores distintas ao ativar) */
  .toggle{display:flex; gap:12px}
  .toggle .btn{padding:14px 18px; font-size:14px}
  .btn-mode.offset.active{background: linear-gradient(135deg,#d97706,#f59e0b)}   /* √¢mbar */
  .btn-mode.digital.active{background: linear-gradient(135deg,#059669,#10b981)}  /* verde */
  .tec-msg{margin-top:8px; font-size:12px; color:#0b4f6c; background:#e6f6f2; border:1px solid #b8efe1; padding:8px 10px; border-radius:8px; display:none}
  .tec-msg.show{display:block}

  /* √Årea de colagem: imagens DENTRO do quadro */
  .dropzone{
    border:2px dashed #9ac7d2; border-radius:12px; padding:22px; background:#f1f7f9;
    color:#557a86; text-align:center; position:relative; min-height:160px;
  }
  .dz-hint{pointer-events:none}
  .dz-grid{
    display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap:10px; place-items:center; margin-top:10px;
  }
  .thumb{width:120px; height:120px; border-radius:10px; overflow:hidden; position:relative; background:#e2eef2; box-shadow:0 2px 10px rgba(10,20,35,.12)}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .thumb button{position:absolute; top:6px; right:6px; background:rgba(0,0,0,.6); color:#fff; border:0; border-radius:8px; padding:4px 6px; cursor:pointer}

  /* Tabelas */
  table{width:100%; border-collapse:separate; border-spacing:0 8px}
  thead th{font-size:12px; color:#6a7a8a; text-align:left; padding:0 10px}
  tbody tr{background:#fff; box-shadow:0 2px 10px rgba(10,20,35,.10)}
  tbody td{padding:8px 10px}

  /* Resumo fixo + rodap√© */
  .summary{position:fixed; left:0; right:0; bottom:0; padding:8px 0 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.18));
    backdrop-filter: blur(6px); border-top:1px solid rgba(255,255,255,.25);
  }
  .summary .wrap{display:grid; grid-template-columns: repeat(7, 1fr) 300px; gap:10px}
  .kpi{background:rgba(255,255,255,.92); border:1px solid var(--stroke); border-radius:12px; padding:8px; text-align:center}
  .kpi .k{font-size:12px; color:#6f7b8c}
  .kpi .v{font-size:16px; font-weight:800; margin-top:2px}
  .right{display:flex; gap:10px; align-items:center; justify-content:flex-end}
  .brand{font-weight:700; color:#0b4f6c}

  /* Rodap√© fixo de assinatura (sempre vis√≠vel) */
  .brand-bar{
    position:fixed; left:0; right:0; bottom:72px; /* pouco acima do resumo */
    text-align:center; color:#dce7eb; font-size:12px;
  }

  /* Impress√£o: mostrar KPIs e assinatura */
  #printSummary{display:none}
  @media print{
    body{background:#fff}
    .summary, .brand-bar, .drawer{display:none !important}
    .wrap{margin:0; max-width:100%}
    .card{box-shadow:none}
    @page { size: A4; margin: 12mm }
    #printSummary{display:block; margin-top:8mm}
    #printSummary .kpis{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    #printSummary .kpi{border:1px solid #cfd6de;border-radius:8px;padding:6px;text-align:center}
    #printSummary .k{font-size:11px;color:#5b6676}
    #printSummary .v{font-size:14px;font-weight:800;margin-top:2px}
    #printSign{margin-top:6mm; text-align:center; font-size:12px; color:#0b4f6c}
  }
</style>
</head>
<body>
  <div class="wrap" id="printRoot">
    <!-- HEADER -->
    <header class="app">
      ./logo-digra.png
      <div id="logoFallback" class="logo-fallback">DG</div>
      <h1>Or√ßamento Gr√°fico</h1>
      <div style="flex:1"></div>
      <button id="btnEditBase" class="btn secondary">‚öôÔ∏è Valores Base</button>
      <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir / Salvar PDF</button>
    </header>

    <!-- INFORMA√á√ïES INICIAIS -->
    <section class="card" id="cardInfo">
      <div class="card-header-bar"><div class="dot">üßæ</div><div class="title">Informa√ß√µes Iniciais</div></div>
      <div class="grid cols-3">
        <div>
          <label>Quantidade Total de Itens *</label>
          <input type="number" id="qtdItens" min="1" placeholder="ex.: 1000" />
        </div>
        <div>
          <label>Tamanho Final do Produto *</label>
          <input type="text" id="tamFinal" placeholder="ex.: 10x15cm" />
        </div>
        <div>
          <label>Tecnologia de Impress√£o *</label>
          <div class="toggle" role="group" aria-label="Tecnologia de Impress√£o">
            <button class="btn btn-mode offset" id="btnOffset" type="button">‚öôÔ∏è OFFSET</button>
            <button class="btn btn-mode digital" id="btnDigital" type="button">üñ®Ô∏è DIGITAL</button>
          </div>
          <div id="tecMsg" class="tec-msg"></div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Descri√ß√£o do Servi√ßo</label>
          <textarea id="desc" placeholder="ex.: Folder A4 4x4, 2 dobras, lamina√ß√£o fosca frente"></textarea>
        </div>
        <div>
          <label>Dados T√©cnicos</label>
          <textarea id="dadosTec" placeholder="ex.: Papel couch√™ 150g, tiragem 1000, faca 2a0b, etc."></textarea>
        </div>
      </div>
    </section>

    <!-- IMAGENS -->
    <section class="card" id="cardImgs">
      <div class="card-header-bar"><div class="dot">üñºÔ∏è</div><div class="title">Imagens do Projeto</div></div>
      <div class="dropzone" id="dropzone" tabindex="0">
        <div class="dz-hint">
          <div style="font-size:28px;margin-bottom:8px">üñºÔ∏è</div>
          <div><strong>Clique para ativar</strong> e cole suas imagens (Ctrl+V)</div>
          <div style="font-size:12px; color:#6c8190">Aceita m√∫ltiplas imagens ‚Ä¢ tamb√©m arraste e solte</div>
        </div>
        <div id="dzGrid" class="dz-grid"></div>
      </div>
    </section>

    <!-- PAP√âIS -->
    <section class="card" id="cardPapeis">
      <div class="card-header-bar"><div class="dot">üìÑ</div><div class="title">Pap√©is Utilizados</div></div>
      <button class="btn ghost" type="button" id="addPapel">+ Adicionar Papel</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Papel</th>
            <th style="width:14%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ por unidade</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblPapeis"></tbody>
      </table>
    </section>

    <!-- MATERIAIS -->
    <section class="card" id="cardMateriais">
      <div class="card-header-bar"><div class="dot">üõ†Ô∏è</div><div class="title">Materiais Utilizados</div></div>
      <button class="btn ghost" type="button" id="addMaterial">+ Adicionar Material</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:26%">Material</th>
            <th style="width:20%">Tipo</th>
            <th style="width:16%">Tamanho</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMateriais"></tbody>
      </table>
    </section>

    <!-- IMPRESS√ÉO DIGITAL -->
    <section class="card" id="cardImp">
      <div class="card-header-bar"><div class="dot">üñ®Ô∏è</div><div class="title">Impress√£o Digital</div></div>
      <button class="btn ghost" type="button" id="addImp">+ Adicionar Impress√£o</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:28%">Tipo</th>
            <th style="width:14%">Formato</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">R$ unit.</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblImp"></tbody>
      </table>
    </section>

    <!-- M√ÉO DE OBRA (por MINUTO) -->
    <section class="card" id="cardMO">
      <div class="card-header-bar"><div class="dot">üë•</div><div class="title">M√£o de Obra (minutos)</div></div>
      <button class="btn ghost" type="button" id="addMao">+ Adicionar Profissional</button>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th style="width:30%">Profissional</th>
            <th style="width:14%">Minutos</th>
            <th style="width:14%">R$ / minuto</th>
            <th style="width:14%">Custo Total</th>
            <th style="width:10%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tblMao"></tbody>
      </table>
    </section>

    <!-- RESUMO PARA IMPRESS√ÉO -->
    <div id="printSummary" class="card">
      <div class="card-header-bar"><div class="dot">üí°</div><div class="title">Resumo Financeiro</div></div>
      <div class="kpis">
        <div class="kpi"><div class="k">Pap√©is</div><div class="v" id="psPapeis">R$ 0,00</div></div>
        <div class="kpi"><div class="k">Materiais</div><div class="v" id="psMateriais">R$ 0,00</div></div>
        <div class="kpi"><div class="k">Impress√£o</div><div class="v" id="psImp">R$ 0,00</div></div>
        <div class="kpi"><div class="k">M√£o de Obra</div><div class="v" id="psMao">R$ 0,00</div></div>
        <div class="kpi"><div class="k">Acr√©sc. 10%</div><div class="v" id="psAcresc">R$ 0,00</div></div>
        <div class="kpi"><div class="k">TOTAL GERAL</div><div class="v" id="psTotal">R$ 0,00</div></div>
        <div class="kpi"><div class="k">Valor Unit√°rio</div><div class="v" id="psUnit">R$ 0,00</div></div>
      </div>
      <div id="printSign">‚ö° Alexandre | DIGRA Apps</div>
    </div>
  </div>

  <!-- RODAP√â FIXO (assinatura) -->
  <div class="brand-bar">‚ö° Alexandre | DIGRA Apps</div>

  <!-- BARRA RESUMO FIXA -->
  <div class="summary">
    <div class="wrap">
      <div class="kpi"><div class="k">Pap√©is</div><div class="v" id="kpiPapeis">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Materiais</div><div class="v" id="kpiMateriais">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Impress√£o</div><div class="v" id="kpiImp">R$ 0,00</div></div>
      <div class="kpi"><div class="k">M√£o de Obra</div><div class="v" id="kpiMao">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Acr√©sc. 10%</div><div class="v" id="kpiAcresc">R$ 0,00</div></div>
      <div class="kpi"><div class="k">TOTAL GERAL</div><div class="v" id="kpiTotal">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Valor Unit√°rio</div><div class="v" id="kpiUnit">R$ 0,00</div></div>
      <div class="right">
        <span class="brand">‚ö° Alexandre | DIGRA Apps</span>
        <button class="btn secondary" id="btnEditBase2">‚öôÔ∏è Valores Base</button>
        <button class="btn" id="btnPrint2">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- DRAWER: VALORES BASE -->
  <div class="drawer" id="drawer" style="display:none;position:fixed;inset:0;background:rgba(10,20,35,.45)">
    <div class="panel" style="margin-left:auto; width:min(880px,92%); height:100%; background:#fff; border-top-left-radius:18px; border-bottom-left-radius:18px; box-shadow:-8px 0 28px rgba(0,0,0,.25); display:flex; flex-direction:column;">
      <div style="padding:16px;border-bottom:1px solid #e9edf2;display:flex;gap:12px;align-items:center">
        <strong>‚öôÔ∏è Valores Base e Configura√ß√µes</strong>
        <div style="flex:1"></div>
        <button class="btn ghost" id="btnCloseDrawer">Fechar</button>
      </div>
      <div style="padding:16px;overflow:auto">
        <div class="tabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <button class="tab active" data-tab="papeis" style="padding:8px 12px;border-radius:999px;border:1px solid #d8e4ea;background:#eef6f8;color:#0b4f6c;font-weight:800;cursor:pointer">Pap√©is</button>
          <button class="tab" data-tab="materiais" style="padding:8px 12px;border-radius:999px;border:1px solid #d8e4ea;background:#eef6f8;color:#0b4f6c;font-weight:800;cursor:pointer">Materiais</button>
          <button class="tab" data-tab="imp" style="padding:8px 12px;border-radius:999px;border:1px solid #d8e4ea;background:#eef6f8;color:#0b4f6c;font-weight:800;cursor:pointer">Impress√£o Digital</button>
          <button class="tab" data-tab="mao" style="padding:8px 12px;border-radius:999px;border:1px solid #d8e4ea;background:#eef6f8;color:#0b4f6c;font-weight:800;cursor:pointer">M√£o de Obra</button>
          <span style="flex:1"></span>
          <button class="btn ghost" id="btnExport">Exportar JSON</button>
          <label class="btn ghost" for="importJson" style="cursor:pointer;">Importar JSON</label>
          <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </div>

        <!-- PAPEIS -->
        <section data-pane="papeis">
          <div class="small" style="margin-bottom:8px">Valores por A4, A3, Folha 66√ó96 e Pacote.</div>
          <table>
            <thead><tr><th>Nome do Papel</th><th>R$ A4</th><th>R$ A3</th><th>R$ Folha</th><th>R$ Pacote</th><th>Folhas/Pacote</th><th>A√ß√µes</th></tr></thead>
            <tbody id="basePapeis"></tbody>
          </table>
          <button class="btn ghost" id="baseAddPapel" style="margin-top:10px">+ Adicionar Papel</button>
        </section>

        <!-- MATERIAIS -->
        <section data-pane="materiais" style="display:none">
          <div class="small" style="margin-bottom:8px">‚ÄúTipo‚Äù possui nome e valor pr√≥prio (ex.: Espiral ‚Üí 7mm, 9mm...).</div>
          <table>
            <thead><tr><th>Material</th><th>Tipos (nome ‚Üí valor)</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMateriais"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMaterial" style="margin-top:10px">+ Adicionar Material</button>
        </section>

        <!-- IMPRESS√ÉO DIGITAL -->
        <section data-pane="imp" style="display:none">
          <div class="small" style="margin-bottom:8px">Somente A4/A3. Tipos: PRETO (1 lado), PRETO (FRENTE E VERSO), COLORIDO (1 lado), COLORIDO (FRENTE E VERSO).</div>
          <table>
            <thead><tr><th>Tipo</th><th>Formato</th><th>R$ unit.</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseImp"></tbody>
          </table>
          <button class="btn ghost" id="baseAddImp" style="margin-top:10px">+ Adicionar Impress√£o</button>
        </section>

        <!-- M√ÉO DE OBRA -->
        <section data-pane="mao" style="display:none">
          <div class="small" style="margin-bottom:8px">Informe valor por HORA. O sistema calcula por MINUTO automaticamente (hora √∑ 60).</div>
          <table>
            <thead><tr><th>Profissional</th><th>R$ por Hora</th><th>A√ß√µes</th></tr></thead>
            <tbody id="baseMao"></tbody>
          </table>
          <button class="btn ghost" id="baseAddMao" style="margin-top:10px">+ Adicionar Profissional</button>
        </section>
      </div>
      <div style="padding:12px 16px;border-top:1px solid #e9edf2;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn secondary" id="btnResetBase">‚Ü∫ Restaurar Padr√µes</button>
        <button class="btn" id="btnSaveBase">üíæ Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const fmtBR = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const $  = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  // ========= BASE OFICIAL (se precisar mudar, use ‚öôÔ∏è ou Importar JSON) =========
  const STORAGE = { base:'digra.base.v2' };

  const BASE_OFICIAL = {
    papeis: [
      {nome:'ADESIVO FOSCO 180g', a4:0.33, a3:0.74, folha:2.97, pacote:296.64, folhasPacote:500},
      {nome:'CART√ÉO TRIPLEX 250g', a4:0.35, a3:0.79, folha:3.17, pacote:475.00, folhasPacote:150},
      {nome:'CARTOLINA BRANCA 180g', a4:0.29, a3:0.57, folha:1.14, pacote:114.00, folhasPacote:100},
      {nome:'CARTOLINA BRANCA 240g', a4:0.24, a3:0.48, folha:0.95, pacote:95.00, folhasPacote:100},
      {nome:'COUCH√ä 115g', a4:0.09, a3:0.19, folha:0.77, pacote:192.00, folhasPacote:250},
      {nome:'COUCH√ä 150g', a4:0.08, a3:0.17, folha:0.68, pacote:169.45, folhasPacote:250},
      {nome:'COUCH√ä 210g', a4:0.19, a3:0.43, folha:1.71, pacote:256.69, folhasPacote:150},
      {nome:'KRAFT 110g', a4:0.11, a3:0.24, folha:0.97, pacote:241.84, folhasPacote:250},
      {nome:'OPALINE 180g', a4:0.19, a3:0.42, folha:1.68, pacote:114.00, folhasPacote:100},
      {nome:'OFFSET 75g', a4:0.06, a3:0.13, folha:0.53, pacote:132.00, folhasPacote:250},
      {nome:'OFFSET 90g', a4:0.05, a3:0.12, folha:0.47, pacote:236.71, folhasPacote:500},
      {nome:'OFFSET 120g', a4:0.09, a3:0.20, folha:0.80, pacote:200.01, folhasPacote:250},
      {nome:'VERG√ä 80g', a4:0.04, a3:0.10, folha:0.39, pacote:98.64, folhasPacote:250},
      {nome:'VERG√ä 180g', a4:0.12, a3:0.28, folha:1.12, pacote:139.49, folhasPacote:125}
    ],
    // Materiais: cada material tem uma lista de "tipos" (cada tipo tem seu pr√≥prio valor)
    materiais: [
      {nome:'LASER FILME', tipos:[
        {nome:'A3 (29,7√ó42,0 cm) ‚Äì por folha', valor:3.57},
        {nome:'OF√çCIO II (21,6√ó33,0 cm) ‚Äì por folha', valor:1.90}
      ]},
      {nome:'CHAPA OFFSET POSITIVA', tipos:[
        {nome:'SAKURAI 400√ó520√ó0,30 mm (unidade)', valor:7.58},
        {nome:'HEIDELBERG 459√ó525√ó0,15 mm (unidade)', valor:14.00}
      ]},
      {nome:'CHAPA OFFSET T√âRMICA DIGITAL (CTP)', tipos:[
        {nome:'SAKURAI (unidade)', valor:57.00},
        {nome:'HEIDELBERG (unidade)', valor:54.50}
      ]},
      {nome:'ESPIRAL (por unidade)', tipos:[
        {nome:'7 mm', valor:0.11},{nome:'9 mm', valor:0.13},{nome:'12 mm', valor:0.28},
        {nome:'14 mm', valor:0.36},{nome:'17 mm', valor:0.44},{nome:'20 mm', valor:0.64},
        {nome:'23 mm', valor:0.75},{nome:'25 mm', valor:0.98},{nome:'29 mm', valor:1.25},
        {nome:'33 mm', valor:1.52},{nome:'40 mm', valor:1.70},{nome:'45 mm', valor:2.37},{nome:'50 mm', valor:3.16}
      ]},
      {nome:'CAPA PP 0,30 (por unidade)', tipos:[
        {nome:'Transparente', valor:0.40},
        {nome:'Preta', valor:0.30}
      ]},
      {nome:'FITA DUPLA FACE (valor por cm)', tipos:[
        {nome:'19 mm', valor:0.0050},
        {nome:'25 mm', valor:0.0043},
        {nome:'50 mm', valor:0.0086}
      ]},
      {nome:'BOBINA POLIETILENO 34cm √ó 0,05 mm √ó 60 m (valor por cm)', tipos:[
        {nome:'Padr√£o', valor:0.0342}
      ]},
      {nome:'ADESIVO VINIL (valor por metro)', tipos:[
        {nome:'Preto', valor:14.40},
        {nome:'Azul M√©dio', valor:15.86},
        {nome:'Vermelho M√©dio', valor:18.31},
        {nome:'Transparente', valor:9.90},
        {nome:'M√°scara de Transfer√™ncia', valor:17.11}
      ]},
      {nome:'BOLSA PARA PASTAS (unidade)', tipos:[
        {nome:'25√ó11 ‚Äì 240g + fita 19mm', valor:0.27}
      ]}
    ],
    // Impress√£o digital (somente A4/A3) com tipos humanizados
    imps: [
      {tipo:'PRETO (1 lado)', formato:'A4', valor:0.03},
      {tipo:'PRETO (1 lado)', formato:'A3', valor:0.06},
      {tipo:'PRETO (FRENTE E VERSO)', formato:'A4', valor:0.06},
      {tipo:'PRETO (FRENTE E VERSO)', formato:'A3', valor:0.12},
      {tipo:'COLORIDO (1 lado)', formato:'A4', valor:0.25},
      {tipo:'COLORIDO (1 lado)', formato:'A3', valor:0.46},
      {tipo:'COLORIDO (FRENTE E VERSO)', formato:'A4', valor:0.50},
      {tipo:'COLORIDO (FRENTE E VERSO)', formato:'A3', valor:0.92}
    ],
    // M√£o de obra (hora) ‚Äì c√°lculo por minuto na UI (hora / 60)
    mao: [
      {prof:'Coordenador de Artes Gr√°ficas', valorHora:85.67},
      {prof:'Designer Gr√°fico', valorHora:65.00},
      {prof:'Or√ßamentista Gr√°fico', valorHora:41.37},
      {prof:'Mestre Impressor', valorHora:53.84},
      {prof:'Impressor Digital', valorHora:36.00},
      {prof:'Mestre Impressor Offset', valorHora:53.84},
      {prof:'Impressor Offset', valorHora:36.00},
      {prof:'Operador de Guilhotina', valorHora:36.00},
      {prof:'Mestre de Servi√ßos Gr√°ficos', valorHora:53.84},
      {prof:'Operador de Acabamento Gr√°fico', valorHora:36.00},
      {prof:'Encarregado', valorHora:53.84}
    ]
  };

  function loadBase(){
    try{ return JSON.parse(localStorage.getItem(STORAGE.base)) || JSON.parse(JSON.stringify(BASE_OFICIAL)); }
    catch(e){ return JSON.parse(JSON.stringify(BASE_OFICIAL)); }
  }
  function saveBase(b){ localStorage.setItem(STORAGE.base, JSON.stringify(b)); }
  let base = loadBase();

  // ========= TECNOLOGIA =========
  const tecMsg = $('#tecMsg');
  function setTec(mode){
    const off = $('#btnOffset'), dig = $('#btnDigital');
    off.classList.toggle('active', mode==='OFFSET');
    dig.classList.toggle('active', mode==='DIGITAL');
    if(mode==='OFFSET'){
      tecMsg.textContent = 'OFFSET selecionado: +10% sobre Pap√©is + Materiais.';
      tecMsg.classList.add('show');
    }else{
      tecMsg.textContent = 'DIGITAL selecionado: isento do acr√©scimo de 10%.';
      tecMsg.classList.add('show');
    }
    recalc();
  }
  $('#btnOffset').addEventListener('click', ()=> setTec('OFFSET'));
  $('#btnDigital').addEventListener('click', ()=> setTec('DIGITAL'));
  setTec('DIGITAL');

  // ========= PAP√âIS =========
  const elTblPapeis = $('#tblPapeis');
  $('#addPapel').addEventListener('click', ()=> addRowPapel());

  function addRowPapel(){
    const tr = document.createElement('tr');
    // Papel
    const tdP = document.createElement('td'); const selP = document.createElement('select');
    base.papeis.forEach(p=>{ const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; selP.appendChild(o); });
    tdP.appendChild(selP);
    // Tamanho
    const tdT = document.createElement('td'); const selT = document.createElement('select');
    ['A4','A3','Folha','Pacote'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selT.appendChild(o); });
    tdT.appendChild(selT);
    // Qtd
    const tdQ = document.createElement('td'); const inQ = document.createElement('input'); inQ.type='number'; inQ.min='1'; inQ.placeholder='ex.: 100'; tdQ.appendChild(inQ);
    // Valor
    const tdV = document.createElement('td'); const inV = document.createElement('input'); inV.type='number'; inV.min='0'; inV.step='0.01'; inV.placeholder='R$'; tdV.appendChild(inV);
    // Custo
    const tdC = document.createElement('td'); tdC.textContent = fmtBR.format(0);
    // A√ß√µes
    const tdA = document.createElement('td'); const bt = document.createElement('button'); bt.className='btn ghost'; bt.textContent='Remover'; tdA.appendChild(bt);

    tr.appendChild(tdP); tr.appendChild(tdT); tr.appendChild(tdQ); tr.appendChild(tdV); tr.appendChild(tdC); tr.appendChild(tdA);
    elTblPapeis.appendChild(tr);

    function syncUnit(){
      const def = base.papeis.find(p=>p.nome===selP.value);
      const key = selT.value.toLowerCase(); // a4,a3,folha,pacote
      let unit = 0;
      if(def && typeof def[key] === 'number') unit = def[key];
      inV.value = unit ? unit.toFixed(2) : '';
      update();
    }
    function update(){
      const c = (parseFloat(inQ.value)||0) * (parseFloat(inV.value)||0);
      tdC.textContent = fmtBR.format(c);
      recalc();
    }
    selP.addEventListener('change', syncUnit);
    selT.addEventListener('change', syncUnit);
    inQ.addEventListener('input', update);
    inV.addEventListener('input', update);
    bt.addEventListener('click', ()=>{ tr.remove(); recalc(); });

    // inicia com valores sugeridos
    syncUnit();
  }

  // ========= MATERIAIS =========
  const elTblMat = $('#tblMateriais');
  $('#addMaterial').addEventListener('click', ()=> addRowMaterial());

  function addRowMaterial(){
    const tr = document.createElement('tr');

    // Material
    const tdM = document.createElement('td'); const selM = document.createElement('select');
    base.materiais.forEach(m=>{ const o=document.createElement('option'); o.value=m.nome; o.textContent=m.nome; selM.appendChild(o); });
    tdM.appendChild(selM);

    // Tipo (din√¢mico por material, cada tipo tem seu pr√≥prio valor)
    const tdTipo = document.createElement('td'); const selTipo = document.createElement('select'); tdTipo.appendChild(selTipo);

    // Tamanho (texto livre)
    const tdTam = document.createElement('td'); const inTam = document.createElement('input'); inTam.type='text'; inTam.placeholder='ex.: 10x15, 2 cm, 3 m'; tdTam.appendChild(inTam);

    // Qtd
    const tdQ = document.createElement('td'); const inQ = document.createElement('input'); inQ.type='number'; inQ.min='1'; inQ.placeholder='ex.: 1'; tdQ.appendChild(inQ);

    // Valor unit (vem do tipo escolhido, mas pode ser ajustado)
    const tdV = document.createElement('td'); const inV = document.createElement('input'); inV.type='number'; inV.step='0.0001'; inV.min='0'; inV.placeholder='R$'; tdV.appendChild(inV);

    // Custo
    const tdC = document.createElement('td'); tdC.textContent = fmtBR.format(0);

    // A√ß√µes
    const tdA = document.createElement('td'); const bt = document.createElement('button'); bt.className='btn ghost'; bt.textContent='Remover'; tdA.appendChild(bt);

    [tdM, tdTipo, tdTam, tdQ, tdV, tdC, tdA].forEach(td=> tr.appendChild(td));
    elTblMat.appendChild(tr);

    function fillTipos(){
      selTipo.innerHTML='';
      const def = base.materiais.find(m=>m.nome===selM.value);
      const tipos = def?.tipos||[];
      tipos.forEach(t=>{
        const o = document.createElement('option');
        o.value = t.nome; o.textContent = t.nome; o.dataset.valor = t.valor;
        selTipo.appendChild(o);
      });
      syncValorTipo();
    }
    function syncValorTipo(){
      const opt = selTipo.selectedOptions[0];
      const v = opt ? Number(opt.dataset.valor||0) : 0;
      inV.value = v ? v.toFixed(v<1 ? 4 : 2) : '';
      update();
    }
    function update(){
      const c = (parseFloat(inQ.value)||0) * (parseFloat(inV.value)||0);
      tdC.textContent = fmtBR.format(c);
      recalc();
    }

    selM.addEventListener('change', fillTipos);
    selTipo.addEventListener('change', syncValorTipo);
    inQ.addEventListener('input', update);
    inV.addEventListener('input', update);
    bt.addEventListener('click', ()=>{ tr.remove(); recalc(); });

    fillTipos(); // inicial
  }

  // ========= IMPRESS√ÉO DIGITAL =========
  const elTblImp = $('#tblImp');
  $('#addImp').addEventListener('click', ()=> addRowImp());

  function addRowImp(){
    const tr = document.createElement('tr');

    const tipos = [...new Set(base.imps.map(i=>i.tipo))];
    const tdTipo = document.createElement('td'); const selTipo = document.createElement('select');
    tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o); });
    tdTipo.appendChild(selTipo);

    const tdFmt = document.createElement('td'); const selFmt = document.createElement('select'); tdFmt.appendChild(selFmt);

    const tdQ = document.createElement('td'); const inQ = document.createElement('input'); inQ.type='number'; inQ.min='1'; inQ.placeholder='ex.: 100'; tdQ.appendChild(inQ);
    const tdV = document.createElement('td'); const inV = document.createElement('input'); inV.type='number'; inV.step='0.01'; inV.min='0'; inV.placeholder='R$'; tdV.appendChild(inV);
    const tdC = document.createElement('td'); tdC.textContent = fmtBR.format(0);
    const tdA = document.createElement('td'); const bt = document.createElement('button'); bt.className='btn ghost'; bt.textContent='Remover'; tdA.appendChild(bt);

    [tdTipo, tdFmt, tdQ, tdV, tdC, tdA].forEach(td=> tr.appendChild(td));
    elTblImp.appendChild(tr);

    function fillFormatos(){
      selFmt.innerHTML='';
      const formatos = base.imps.filter(x=>x.tipo===selTipo.value).map(x=>x.formato).filter(f=>f==='A4'||f==='A3');
      [...new Set(formatos)].forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; selFmt.appendChild(o); });
      syncValor();
    }
    function syncValor(){
      const it = base.imps.find(x=>x.tipo===selTipo.value && x.formato===selFmt.value);
      inV.value = (it? it.valor:0).toFixed(2);
      update();
    }
    function update(){
      const c = (parseFloat(inV.value)||0) * (parseFloat(inQ.value)||0);
      tdC.textContent = fmtBR.format(c);
      recalc();
    }

    selTipo.addEventListener('change', fillFormatos);
    selFmt.addEventListener('change', syncValor);
    inQ.addEventListener('input', update);
    inV.addEventListener('input', update);
    bt.addEventListener('click', ()=>{ tr.remove(); recalc(); });

    fillFormatos(); // inicial
  }

  // ========= M√ÉO DE OBRA (MINUTOS) =========
  const elTblMao = $('#tblMao');
  $('#addMao').addEventListener('click', ()=> addRowMao());

  function addRowMao(){
    const tr = document.createElement('tr');

    const tdProf = document.createElement('td'); const selProf = document.createElement('select');
    base.mao.forEach(m=>{ const o=document.createElement('option'); o.value=m.prof; o.textContent=m.prof; selProf.appendChild(o); });
    tdProf.appendChild(selProf);

    const tdMin = document.createElement('td'); const inMin = document.createElement('input'); inMin.type='number'; inMin.min='1'; inMin.placeholder='ex.: 30'; tdMin.appendChild(inMin);

    const tdVmin = document.createElement('td'); const inVmin = document.createElement('input'); inVmin.type='number'; inVmin.step='0.01'; inVmin.min='0'; inVmin.placeholder='R$'; tdVmin.appendChild(inVmin);

    const tdC = document.createElement('td'); tdC.textContent = fmtBR.format(0);
    const tdA = document.createElement('td'); const bt = document.createElement('button'); bt.className='btn ghost'; bt.textContent='Remover'; tdA.appendChild(bt);

    [tdProf, tdMin, tdVmin, tdC, tdA].forEach(td=> tr.appendChild(td));
    elTblMao.appendChild(tr);

    function syncValorMin(){
      const def = base.mao.find(m=>m.prof===selProf.value);
      const v = def ? (Number(def.valorHora||0)/60) : 0;
      inVmin.value = v ? v.toFixed(2) : '';
      update();
    }
    function update(){
      const c = (parseFloat(inVmin.value)||0) * (parseFloat(inMin.value)||0);
      tdC.textContent = fmtBR.format(c);
      recalc();
    }

    selProf.addEventListener('change', syncValorMin);
    inMin.addEventListener('input', update);
    inVmin.addEventListener('input', update);
    bt.addEventListener('click', ()=>{ tr.remove(); recalc(); });

    syncValorMin(); // inicial
  }

  // ========= RESUMO / C√ÅLCULO =========
  function recalc(){
    const papelTotal = Array.from($('#tblPapeis').querySelectorAll('tr')).reduce((acc,tr)=>{
      const qtd = parseFloat(tr.children[2].querySelector('input').value)||0;
      const val = parseFloat(tr.children[3].querySelector('input').value)||0;
      const c = qtd*val; tr.children[4].textContent = fmtBR.format(c); return acc + c;
    },0);
    const matTotal = Array.from($('#tblMateriais').querySelectorAll('tr')).reduce((acc,tr)=>{
      const qtd = parseFloat(tr.children[3].querySelector('input').value)||0;
      const val = parseFloat(tr.children[4].querySelector('input').value)||0;
      const c = qtd*val; tr.children[5].textContent = fmtBR.format(c); return acc + c;
    },0);
    const impTotal = Array.from($('#tblImp').querySelectorAll('tr')).reduce((acc,tr)=>{
      const qtd = parseFloat(tr.children[2].querySelector('input').value)||0;
      const val = parseFloat(tr.children[3].querySelector('input').value)||0;
      const c = qtd*val; tr.children[4].textContent = fmtBR.format(c); return acc + c;
    },0);
    const maoTotal = Array.from($('#tblMao').querySelectorAll('tr')).reduce((acc,tr)=>{
      const min = parseFloat(tr.children[1].querySelector('input').value)||0;
      const vmin= parseFloat(tr.children[2].querySelector('input').value)||0;
      const c = min*vmin; tr.children[3].textContent = fmtBR.format(c); return acc + c;
    },0);

    const isOffset = $('#btnOffset').classList.contains('active');
    const acresc = isOffset ? 0.10 * (papelTotal + matTotal) : 0;
    const total = papelTotal + matTotal + impTotal + maoTotal + acresc;

    $('#kpiPapeis').textContent = fmtBR.format(papelTotal);
    $('#kpiMateriais').textContent = fmtBR.format(matTotal);
    $('#kpiImp').textContent = fmtBR.format(impTotal);
    $('#kpiMao').textContent = fmtBR.format(maoTotal);
    $('#kpiAcresc').textContent = fmtBR.format(acresc);
    $('#kpiTotal').textContent = fmtBR.format(total);

    const itens = Math.max(1, parseInt($('#qtdItens').value||'0',10));
    const unit = itens>0 ? (total / itens) : 0;
    $('#kpiUnit').textContent = fmtBR.format(unit);

    // preparar blocos de impress√£o
    $('#psPapeis').textContent = fmtBR.format(papelTotal);
    $('#psMateriais').textContent = fmtBR.format(matTotal);
    $('#psImp').textContent = fmtBR.format(impTotal);
    $('#psMao').textContent = fmtBR.format(maoTotal);
    $('#psAcresc').textContent = fmtBR.format(acresc);
    $('#psTotal').textContent = fmtBR.format(total);
    $('#psUnit').textContent = fmtBR.format(unit);
  }

  // ========= COLAR / ARRASTAR IMAGENS (dentro do quadro) =========
  const dz = $('#dropzone');
  const dzGrid = $('#dzGrid');
  let dzActive = false;

  function addImg(url){
    const div = document.createElement('div'); div.className='thumb';
    const img = new Image(); img.src = url; div.appendChild(img);
    const x = document.createElement('button'); x.textContent='‚úñ'; x.title='Remover'; x.onclick=()=>div.remove();
    div.appendChild(x); dzGrid.appendChild(div);
  }

  dz.addEventListener('click', ()=>{ dzActive = true; dz.focus(); dz.style.background='#e8f2f5'; setTimeout(()=> dz.style.background='#f1f7f9',300); });

  document.addEventListener('paste', (e)=>{
    if(!dzActive) return;
    const items = e.clipboardData?.items||[];
    const imgs = [...items].filter(it=> it.type && it.type.startsWith('image/'));
    if(imgs.length){ e.preventDefault(); }
    imgs.forEach(it=>{
      const f = it.getAsFile(); if(!f) return;
      const url = URL.createObjectURL(f);
      addImg(url);
    });
  });
  dz.addEventListener('dragover', e=>{ e.preventDefault(); });
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dzActive = true;
    const fs = e.dataTransfer.files;
    for(const f of fs){ if(f.type.startsWith('image/')) addImg(URL.createObjectURL(f)); }
  });

  // ========= IMPRESS√ÉO =========
  function printScaled(){
    const root = document.getElementById('printRoot');
    // medi√ß√£o A4
    const probe = document.createElement('div');
    probe.style.width='210mm'; probe.style.height='297mm'; probe.style.position='absolute'; probe.style.visibility='hidden';
    document.body.appendChild(probe);
    const a4h = probe.getBoundingClientRect().height; document.body.removeChild(probe);

    const max = a4h*2 - 24; // 2 p√°ginas
    const h = root.getBoundingClientRect().height;
    const scale = h>max ? (max/h) : 1;

    const oldT = root.style.transform, oldO = root.style.transformOrigin;
    root.style.transformOrigin = 'top center';
    root.style.transform = 'scale('+scale+')';
    setTimeout(()=>{ window.print(); setTimeout(()=>{ root.style.transform=oldT; root.style.transformOrigin=oldO; }, 100); }, 80);
  }
  $('#btnPrint').addEventListener('click', printScaled);
  $('#btnPrint2').addEventListener('click', printScaled);

  // ========= DRAWER (BASE) =========
  const drawer = $('#drawer');
  function openDrawer(){ renderBase(); drawer.style.display='flex'; }
  function closeDrawer(){ drawer.style.display='none'; }
  $('#btnEditBase').addEventListener('click', openDrawer);
  $('#btnEditBase2').addEventListener('click', openDrawer);
  $('#btnCloseDrawer').addEventListener('click', closeDrawer);

  $$('.tab').forEach(tab=> tab.addEventListener('click', ()=>{
    $$('.tab').forEach(t=>{
      t.classList.remove('active');
      t.style.background='#eef6f8';
      t.style.color='#0b4f6c';
    });
    tab.classList.add('active');
    tab.style.background='linear-gradient(135deg,#0b4f6c,#1b9aaa)';
    tab.style.color='#fff';
    const pane = tab.dataset.tab;
    $$('[data-pane]').forEach(p=> p.style.display = (p.getAttribute('data-pane')===pane)?'block':'none');
  }));

  function renderBase(){
    // Pap√©is
    const tbP = $('#basePapeis'); tbP.innerHTML='';
    base.papeis.forEach((p,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${p.nome}"></td>
        <td><input type="number" step="0.01" value="${p.a4}"></td>
        <td><input type="number" step="0.01" value="${p.a3}"></td>
        <td><input type="number" step="0.01" value="${p.folha}"></td>
        <td><input type="number" step="0.01" value="${p.pacote}"></td>
        <td><input type="number" step="1" value="${p.folhasPacote||500}"></td>`;
      const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; del.onclick=()=>{ base.papeis.splice(idx,1); renderBase(); }; td.appendChild(del); tr.appendChild(td);
      tbP.appendChild(tr);
    });

    // Materiais
    const tbM = $('#baseMateriais'); tbM.innerHTML='';
    base.materiais.forEach((m,idx)=>{
      const tr=document.createElement('tr');
      // editor simples: lista de tipos ‚Äúnome=valor‚Äù separados por ;
      const tiposStr = (m.tipos||[]).map(t=> `${t.nome}=${t.valor}`).join('; ');
      tr.innerHTML = `
        <td><input value="${m.nome}"></td>
        <td><input value="${tiposStr}" placeholder="ex.: 7 mm=0.11; 9 mm=0.13; ..."></td>`;
      const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; del.onclick=()=>{ base.materiais.splice(idx,1); renderBase(); }; td.appendChild(del); tr.appendChild(td);
      tbM.appendChild(tr);
    });

    // Impress√£o
    const tbI = $('#baseImp'); tbI.innerHTML='';
    base.imps.forEach((i,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${i.tipo}"></td>
        <td><select><option ${i.formato==='A4'?'selected':''}>A4</option><option ${i.formato==='A3'?'selected':''}>A3</option></select></td>
        <td><input type="number" step="0.01" value="${i.valor}"></td>`;
      const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; del.onclick=()=>{ base.imps.splice(idx,1); renderBase(); }; td.appendChild(del); tr.appendChild(td);
      tbI.appendChild(tr);
    });

    // M√£o de Obra
    const tbO = $('#baseMao'); tbO.innerHTML='';
    base.mao.forEach((o,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${o.prof}"></td>
        <td><input type="number" step="0.01" value="${o.valorHora}"></td>`;
      const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Remover'; del.onclick=()=>{ base.mao.splice(idx,1); renderBase(); }; td.appendChild(del); tr.appendChild(td);
      tbO.appendChild(tr);
    });
  }

  // A√ß√µes base
  $('#baseAddPapel').addEventListener('click',()=>{ base.papeis.push({nome:'Novo Papel', a4:0, a3:0, folha:0, pacote:0, folhasPacote:500}); renderBase(); });
  $('#baseAddMaterial').addEventListener('click',()=>{ base.materiais.push({nome:'Novo Material', tipos:[]}); renderBase(); });
  $('#baseAddImp').addEventListener('click',()=>{ base.imps.push({tipo:'PRETO (1 lado)', formato:'A4', valor:0}); renderBase(); });
  $('#baseAddMao').addEventListener('click',()=>{ base.mao.push({prof:'Novo Profissional', valorHora:0}); renderBase(); });

  $('#btnSaveBase').addEventListener('click', ()=>{
    function readRows(sel){ return $$('#'+sel+' tr'); }
    // Pap√©is
    base.papeis = readRows('basePapeis').map(tr=>({
      nome: tr.children[0].querySelector('input').value.trim(),
      a4: Number(tr.children[1].querySelector('input').value||0),
      a3: Number(tr.children[2].querySelector('input').value||0),
      folha: Number(tr.children[3].querySelector('input').value||0),
      pacote: Number(tr.children[4].querySelector('input').value||0),
      folhasPacote: Number(tr.children[5].querySelector('input').value||0)||500
    }));
    // Materiais
    base.materiais = readRows('baseMateriais').map(tr=>{
      const nome = tr.children[0].querySelector('input').value.trim();
      const raw = tr.children[1].querySelector('input').value.trim();
      const tipos = raw.split(';').map(s=>s.trim()).filter(Boolean).map(pair=>{
        const [n,v] = pair.split('=').map(x=>x.trim());
        return {nome:n, valor: Number((v||'0').replace(',','.'))||0};
      });
      return {nome, tipos};
    });
    // Impress√£o
    base.imps = readRows('baseImp').map(tr=>({
      tipo: tr.children[0].querySelector('input').value.trim(),
      formato: tr.children[1].querySelector('select').value,
      valor: Number(tr.children[2].querySelector('input').value||0)
    }));
    // M√£o de obra
    base.mao = readRows('baseMao').map(tr=>({
      prof: tr.children[0].querySelector('input').value.trim(),
      valorHora: Number(tr.children[1].querySelector('input').value||0)
    }));
    saveBase(base);
    alert('Valores base salvos.');
  });

  $('#btnResetBase').addEventListener('click', ()=>{
    if(confirm('Restaurar toda a base oficial?')){
      base = JSON.parse(JSON.stringify(BASE_OFICIAL));
      saveBase(base); renderBase();
    }
  });

  $('#btnExport').addEventListener('click', ()=>{
    const data = JSON.stringify(base, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='digra-valores-base.json'; a.click(); URL.revokeObjectURL(url);
  });

  $('#importJson').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const rdr = new FileReader(); rdr.onload = ()=>{
      try{ base = JSON.parse(rdr.result); saveBase(base); renderBase(); alert('Base importada com sucesso.'); }
      catch(err){ alert('Arquivo inv√°lido.'); }
    }; rdr.readAsText(file);
  });

  // Inicial: n√£o cria linhas autom√°ticas; tudo come√ßa em branco
  recalc();
})();
</script>
</body>
</html>
